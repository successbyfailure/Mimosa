version: "3.9"

services:
  web:
    build:
      context: .
      dockerfile: docker/Dockerfile
    command: ["uvicorn", "mimosa.web.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    env_file:
      - .env
    environment:
      - MIMOSA_ENV=${MIMOSA_ENV:-development}
    ports:
      - "${WEB_PORT:-8000}:8000"
    volumes:
      - ./volumes/web:/var/lib/mimosa/web
      - ./:/app
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport urllib.request\nurllib.request.urlopen('http://localhost:8000/').read()\nprint('ok')\nPY"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mimosa-internal

  worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    command: ["/bin/sh", "-c", "while true; do python -m mimosa.tasks; sleep ${TASK_RUN_INTERVAL:-300}; done"]
    env_file:
      - .env
    environment:
      - MIMOSA_ENV=${MIMOSA_ENV:-development}
    depends_on:
      web:
        condition: service_healthy
    volumes:
      - ./volumes/worker:/var/lib/mimosa/worker
      - ./:/app
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nprint('worker alive')\nPY"]
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - mimosa-internal

  bot:
    build:
      context: .
      dockerfile: docker/Dockerfile
    command: ["/bin/sh", "-c", "python - <<'PY'\nimport os\nfrom mimosa.bot.telegram_bot import MimosaBot\nfrom mimosa.core.api import CoreAPI, FirewallGateway\nfrom mimosa.core.blocking import BlockManager\n\nclass NullGateway(FirewallGateway):\n    def block_ip(self, ip, reason):\n        print(f'[BOT] bloqueo registrado para {ip}: {reason}')\n    def list_blocks(self):\n        return []\n    def unblock_ip(self, ip):\n        print(f'[BOT] desbloqueo registrado para {ip}')\n\ntoken = os.environ.get('TELEGRAM_BOT_TOKEN')\nif not token:\n    raise SystemExit('TELEGRAM_BOT_TOKEN no configurado')\nmax_blocks = int(os.environ.get('TELEGRAM_MAX_BLOCKS', '10'))\napi = CoreAPI(NullGateway(), block_manager=BlockManager())\nbot = MimosaBot(token, api, max_blocks=max_blocks)\nbot.run()\nPY"]
    env_file:
      - .env
    environment:
      - MIMOSA_ENV=${MIMOSA_ENV:-development}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_MAX_BLOCKS=${TELEGRAM_MAX_BLOCKS:-10}
    depends_on:
      web:
        condition: service_healthy
    volumes:
      - ./volumes/bot:/var/lib/mimosa/bot
      - ./:/app
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport os\nimport sys\n\nif not os.environ.get('TELEGRAM_BOT_TOKEN'):\n    sys.exit('falta token')\nprint('bot ready')\nPY"]
      interval: 60s
      timeout: 10s
      retries: 3
    networks:
      - mimosa-internal

networks:
  mimosa-internal:
    driver: bridge
