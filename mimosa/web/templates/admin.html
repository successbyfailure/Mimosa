{% extends "base.html" %}
{% block content %}
<section class="card space">
  <h2 style="margin:0 0 12px">Agregar firewall</h2>
  <form id="firewall-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
    <div>
      <label>Nombre</label>
      <input name="name" required placeholder="pfSense homelab" />
    </div>
    <div>
      <label>Tipo</label>
      <select name="type">
        <option value="pfsense">pfSense (pfRest)</option>
        <option value="opnsense">OPNsense</option>
        <option value="dummy">Dummy</option>
      </select>
    </div>
    <div>
      <label>Base URL</label>
      <input name="base_url" placeholder="https://firewall.local" />
    </div>
    <div>
      <label>Alias</label>
      <input name="alias_name" value="mimosa_blocklist" />
    </div>
    <div>
      <label>API key</label>
      <input name="api_key" />
    </div>
    <div>
      <label>API secret</label>
      <input name="api_secret" />
    </div>
    <div>
      <label>Timeout (s)</label>
      <input name="timeout" type="number" step="0.5" value="5" />
    </div>
    <div style="display:flex; align-items:flex-end; gap:10px;">
      <label style="display:flex; gap:8px; align-items:center;">
        <input type="checkbox" name="verify_ssl" checked style="width:auto;" />
        Verificar SSL
      </label>
      <button type="submit">Guardar</button>
      <button type="button" class="secondary" onclick="testConnection(event)">Probar conexión</button>
    </div>
  </form>
  <div id="form-message" class="muted" style="margin-top:10px;"></div>
</section>

<section class="card">
  <div class="flex space">
    <div>
      <h2 style="margin:0">Firewalls configurados</h2>
      <div class="muted">Se almacenan en <code>data/firewalls.json</code></div>
    </div>
    <button class="secondary" onclick="loadFirewalls()">Actualizar</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Tipo</th>
        <th>Alias</th>
        <th>Verificación SSL</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="fw-table">
      <tr><td colspan="5" class="muted">Cargando...</td></tr>
    </tbody>
  </table>
</section>

<section class="card">
  <div class="flex space">
    <div>
      <h2 style="margin:0">Gestor de bloqueos</h2>
      <div class="muted">Consulta y modifica las listas de bloqueo en el firewall seleccionado.</div>
    </div>
    <div class="flex" style="margin-left:auto; gap:8px;">
      <select id="block-fw-select" onchange="handleFirewallChange(event)" style="min-width:220px"></select>
      <button class="secondary" onclick="refreshBlocks()">Actualizar</button>
    </div>
  </div>

  <div id="block-manager" class="grid" style="grid-template-columns: 2fr 1.4fr; gap: 18px; margin-top:14px;">
    <div>
      <div class="flex space" style="margin-bottom:8px;">
        <div>
          <h3 style="margin:0">Entradas en alias <span id="alias-label" class="muted"></span></h3>
          <div id="block-message" class="muted"></div>
        </div>
      </div>
      <div style="max-height:260px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>IP / Red</th>
              <th style="width:110px;"></th>
            </tr>
          </thead>
          <tbody id="block-table">
            <tr><td colspan="2" class="muted">Selecciona un firewall para listar las entradas.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
      <h3 style="margin-top:0">Añadir entrada</h3>
      <form id="block-form" class="grid" style="grid-template-columns: 1fr; gap: 10px;">
        <div>
          <label>IP o red</label>
          <input name="ip" required placeholder="203.0.113.10" />
        </div>
        <div>
          <label>Motivo</label>
          <input name="reason" placeholder="Añadido manual" />
        </div>
        <div>
          <label>Duración (min, opcional)</label>
          <input name="duration_minutes" type="number" min="0" placeholder="60" />
        </div>
        <button type="submit">Añadir a la lista</button>
      </form>
    </div>
  </div>
</section>

<div id="edit-modal" class="modal">
  <div class="panel">
    <div class="flex space" style="justify-content: space-between;">
      <h3 style="margin:0">Editar firewall</h3>
      <button type="button" class="secondary" onclick="closeEditModal()">Cerrar</button>
    </div>
    <form id="edit-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
      <div>
        <label>Nombre</label>
        <input name="name" required />
      </div>
      <div>
        <label>Tipo</label>
        <select name="type">
          <option value="pfsense">pfSense (pfRest)</option>
          <option value="opnsense">OPNsense</option>
          <option value="dummy">Dummy</option>
        </select>
      </div>
      <div>
        <label>Base URL</label>
        <input name="base_url" placeholder="https://firewall.local" />
      </div>
      <div>
        <label>Alias</label>
        <input name="alias_name" />
      </div>
      <div>
        <label>API key</label>
        <input name="api_key" />
      </div>
      <div>
        <label>API secret</label>
        <input name="api_secret" />
      </div>
      <div>
        <label>Timeout (s)</label>
        <input name="timeout" type="number" step="0.5" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap: wrap;">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="verify_ssl" style="width:auto;" />
          Verificar SSL
        </label>
        <button type="submit">Guardar cambios</button>
        <button type="button" class="secondary" onclick="setupFirewall(event)">Setup Mimosa</button>
      </div>
    </form>
    <div id="edit-message" class="muted" style="margin-top:10px;"></div>
  </div>
</div>

<script>
let firewallsCache = [];
let selectedFirewallId = null;
let editingFirewallId = null;
const editModal = document.getElementById('edit-modal');
const editForm = document.getElementById('edit-form');

function closeEditModal() {
  editingFirewallId = null;
  editModal.classList.remove('open');
  editForm.reset();
  const message = document.getElementById('edit-message');
  message.textContent = '';
  message.style.color = '';
}

function openEditModal(id) {
  const cfg = firewallsCache.find(item => item.id === id);
  if (!cfg) return;
  editingFirewallId = id;
  setFormValues(editForm, cfg);
  const message = document.getElementById('edit-message');
  message.textContent = '';
  message.style.color = '';
  editModal.classList.add('open');
}

async function loadFirewalls() {
  const res = await fetch('/api/firewalls');
  const data = await res.json();
  firewallsCache = data;
  const tbody = document.getElementById('fw-table');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="muted">No hay firewalls configurados.</td></tr>';
    renderBlockSelector();
    return;
  }
  data.forEach(cfg => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${cfg.name}</td>
      <td>${cfg.type}</td>
      <td>${cfg.alias_name}</td>
      <td>${cfg.verify_ssl ? 'Sí' : 'No'}</td>
      <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button class="secondary" onclick="openEditModal('${cfg.id}')">Editar</button>
        <button class="secondary" onclick="deleteFirewall('${cfg.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  if (editingFirewallId && !data.find(cfg => cfg.id === editingFirewallId)) {
    closeEditModal();
  }

  renderBlockSelector();
}

async function deleteFirewall(id) {
  await fetch(`/api/firewalls/${id}`, { method: 'DELETE' });
  if (editingFirewallId === id) {
    closeEditModal();
  }
  loadFirewalls();
}

async function submitForm(event) {
  event.preventDefault();
  const form = event.target;
  const payload = buildPayload(form);
  const res = await fetch('/api/firewalls', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const message = document.getElementById('form-message');
  if (res.ok) {
    message.textContent = 'Guardado correctamente';
    message.style.color = '#67e8f9';
    form.reset();
    form.alias_name.value = 'mimosa_blocklist';
    form.timeout.value = '5';
    form.verify_ssl.checked = true;
    loadFirewalls();
  } else {
    message.textContent = 'Error al guardar';
    message.style.color = '#fca5a5';
  }
}

function buildPayload(form) {
  const payload = Object.fromEntries(new FormData(form));
  payload.verify_ssl = form.verify_ssl.checked;
  payload.timeout = parseFloat(payload.timeout || '5');
  return payload;
}

function setFormValues(form, cfg) {
  form.name.value = cfg.name || '';
  form.type.value = cfg.type || 'pfsense';
  form.base_url.value = cfg.base_url || '';
  form.alias_name.value = cfg.alias_name || '';
  form.api_key.value = cfg.api_key || '';
  form.api_secret.value = cfg.api_secret || '';
  form.timeout.value = cfg.timeout ?? 5;
  form.verify_ssl.checked = Boolean(cfg.verify_ssl);
}

async function testConnection(event) {
  const form = event.target.form;
  const payload = buildPayload(form);
  const message = document.getElementById('form-message');
  message.textContent = 'Probando conexión...';
  message.style.color = '';
  try {
    const res = await fetch('/api/firewalls/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok && data.online) {
      message.textContent = `Conexión OK (${data.type})`;
      message.style.color = '#67e8f9';
    } else {
      message.textContent = data.message || 'No se pudo establecer conexión';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al probar la conexión';
    message.style.color = '#fca5a5';
  }
}

async function submitEdit(event) {
  event.preventDefault();
  if (!editingFirewallId) return;
  const payload = buildPayload(event.target);
  const message = document.getElementById('edit-message');
  message.textContent = 'Guardando...';
  message.style.color = '';
  try {
    const res = await fetch(`/api/firewalls/${editingFirewallId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      message.textContent = 'Firewall actualizado correctamente';
      message.style.color = '#67e8f9';
      await loadFirewalls();
    } else {
      message.textContent = data.detail || 'No se pudo actualizar';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al actualizar el firewall';
    message.style.color = '#fca5a5';
  }
}

async function setupFirewall(event) {
  if (event) event.preventDefault();
  if (!editingFirewallId) return;
  const message = document.getElementById('edit-message');
  message.textContent = 'Preparando alias y listas...';
  message.style.color = '';
  try {
    const res = await fetch(`/api/firewalls/${editingFirewallId}/setup`, { method: 'POST' });
    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      message.textContent = data.message || 'Setup completado';
      message.style.color = '#67e8f9';
    } else {
      message.textContent = data.detail || 'No se pudo preparar el firewall';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error durante el setup';
    message.style.color = '#fca5a5';
  }
}

function renderBlockSelector() {
  const select = document.getElementById('block-fw-select');
  select.innerHTML = '';
  if (!firewallsCache.length) {
    select.innerHTML = '<option value="" disabled selected>Configura un firewall primero</option>';
    updateBlockTableMessage('Añade un firewall para gestionar bloqueos.');
    selectedFirewallId = null;
    return;
  }
  firewallsCache.forEach(cfg => {
    const opt = document.createElement('option');
    opt.value = cfg.id;
    opt.textContent = `${cfg.name} (${cfg.type})`;
    select.appendChild(opt);
  });
  if (!selectedFirewallId) {
    selectedFirewallId = firewallsCache[0].id;
  }
  select.value = selectedFirewallId;
  refreshBlocks();
}

function updateBlockTableMessage(message) {
  const tbody = document.getElementById('block-table');
  tbody.innerHTML = `<tr><td colspan="2" class="muted">${message}</td></tr>`;
}

async function refreshBlocks() {
  if (!selectedFirewallId) {
    updateBlockTableMessage('Configura un firewall para ver las listas.');
    return;
  }
  updateBlockTableMessage('Cargando entradas...');
  const messageEl = document.getElementById('block-message');
  messageEl.textContent = '';
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks`);
    if (!res.ok) {
      updateBlockTableMessage('No se pudo obtener la lista.');
      return;
    }
    const data = await res.json();
    document.getElementById('alias-label').textContent = data.alias ? `(${data.alias})` : '';
    const tbody = document.getElementById('block-table');
    tbody.innerHTML = '';
    if (!data.items || !data.items.length) {
      updateBlockTableMessage('No hay entradas en la lista.');
      return;
    }
    data.items.forEach(ip => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ip}</td>
        <td style="text-align:right"><button class="secondary" onclick="removeBlock('${ip}')">Eliminar</button></td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    updateBlockTableMessage('Error al cargar las entradas.');
  }
}

function handleFirewallChange(event) {
  selectedFirewallId = event.target.value;
  refreshBlocks();
}

async function addBlock(event) {
  event.preventDefault();
  if (!selectedFirewallId) return;
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  if (payload.duration_minutes === '') {
    delete payload.duration_minutes;
  } else {
    payload.duration_minutes = Number(payload.duration_minutes);
  }
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      form.reset();
      document.getElementById('block-message').textContent = 'Entrada añadida correctamente.';
      refreshBlocks();
    } else {
      document.getElementById('block-message').textContent = 'No se pudo añadir la entrada.';
    }
  } catch (error) {
    document.getElementById('block-message').textContent = 'Error al añadir la entrada.';
  }
}

async function removeBlock(ip) {
  if (!selectedFirewallId) return;
  const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks/${encodeURIComponent(ip)}`, { method: 'DELETE' });
  if (res.ok) {
    refreshBlocks();
  } else {
    document.getElementById('block-message').textContent = 'No se pudo eliminar la entrada.';
  }
}

document.getElementById('block-form').addEventListener('submit', addBlock);

document.getElementById('firewall-form').addEventListener('submit', submitForm);
editForm.addEventListener('submit', submitEdit);
editModal.addEventListener('click', (event) => {
  if (event.target === editModal) {
    closeEditModal();
  }
});
loadFirewalls();
</script>
{% endblock %}
