{% extends "base.html" %}
{% block content %}
<style>
  .tabs { display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; }
  .tab-btn { background: rgba(255,255,255,.05); color: var(--text); border: 1px solid rgba(255,255,255,.08); padding: 10px 14px; border-radius: 12px; cursor:pointer; font-weight:700; }
  .tab-btn.active { background: linear-gradient(120deg, #38bdf8, #6366f1); color:white; box-shadow: 0 10px 30px rgba(99,102,241,.35); }
  .tab-panel { display:none; }
  .tab-panel.active { display:block; }
  .pill.warn { background: rgba(251,191,36,.15); color:#fbbf24; }
</style>

<div class="tabs">
  <button class="tab-btn active" data-tab="config" onclick="switchTab('config')">Configuración</button>
  <button class="tab-btn" data-tab="plugins" onclick="switchTab('plugins')">Plugins</button>
  <button class="tab-btn" data-tab="offenses" onclick="switchTab('offenses')">Ofensas</button>
  <button class="tab-btn" data-tab="blocks" onclick="switchTab('blocks')">Bloqueos</button>
  <button class="tab-btn" data-tab="ips" onclick="switchTab('ips')">IP inspector</button>
  <button class="tab-btn" data-tab="whitelist" onclick="switchTab('whitelist')">Whitelist</button>
</div>

<section id="tab-config" class="tab-panel active">
  <section class="card space">
    <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
      <div>
        <h2 style="margin:0 0 12px">Gestor de bloqueos</h2>
        <div class="muted">Configura la duración por defecto y la frecuencia de sincronización con el firewall.</div>
      </div>
      <span class="pill warn">Revisa que el firewall no caduca los bloqueos automáticamente</span>
    </div>
    <form id="blocking-settings" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
      <div>
        <label>Duración por defecto (min)</label>
        <input name="default_duration_minutes" type="number" min="1" value="60" />
      </div>
      <div>
        <label>Intervalo de comprobación (s)</label>
        <input name="sync_interval_seconds" type="number" min="5" value="300" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px;">
        <button type="submit">Guardar</button>
        <div id="blocking-settings-message" class="muted"></div>
      </div>
    </form>
  </section>

  <section class="card space">
    <h2 style="margin:0 0 12px">Agregar firewall</h2>
    <form id="firewall-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
      <div>
        <label>Nombre</label>
        <input name="name" required placeholder="pfSense homelab" />
      </div>
      <div>
        <label>Tipo</label>
        <select name="type">
          <option value="pfsense">pfSense (pfRest)</option>
          <option value="opnsense">OPNsense</option>
          <option value="ssh_iptables">SSH + iptables</option>
          <option value="dummy">Dummy</option>
        </select>
      </div>
      <div>
        <label>Base URL</label>
        <input name="base_url" placeholder="https://firewall.local" />
      </div>
      <div>
        <label>Alias</label>
        <input name="alias_name" value="mimosa_blocklist" />
      </div>
      <div>
        <label>API key</label>
        <input name="api_key" />
      </div>
      <div>
        <label>API secret</label>
        <input name="api_secret" />
      </div>
      <div>
        <label>Host SSH</label>
        <input name="ssh_host" placeholder="firewall.local" />
      </div>
      <div>
        <label>Usuario SSH</label>
        <input name="ssh_user" placeholder="root" />
      </div>
      <div>
        <label>Puerto SSH</label>
        <input name="ssh_port" type="number" min="1" max="65535" value="22" />
      </div>
      <div>
        <label>Ruta llave SSH</label>
        <input name="ssh_key_path" placeholder="/home/mimosa/.ssh/id_rsa" />
      </div>
      <div>
        <label>Timeout (s)</label>
        <input name="timeout" type="number" step="0.5" value="5" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap: wrap;">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="verify_ssl" checked style="width:auto;" />
          Verificar SSL
        </label>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="apply_changes" checked style="width:auto;" />
          Recargar reglas tras cambios
        </label>
        <button type="submit">Guardar</button>
        <button type="button" class="secondary" onclick="testConnection(event)">Probar conexión</button>
      </div>
    </form>
    <div id="form-message" class="muted" style="margin-top:10px;"></div>
  </section>

  <p class="muted" style="margin-top:-6px; margin-bottom:18px;">
    Cuando está activo <strong>Recargar reglas tras cambios</strong>, Mimosa invoca el endpoint de apply/reload del firewall
    después de crear alias y modificar entradas. Desactívalo solo en entornos de prueba para evitar aplicar cambios reales.
  </p>

  <section class="card">
    <div class="flex space">
      <div>
        <h2 style="margin:0">Firewalls configurados</h2>
        <div class="muted">Se almacenan en <code>data/firewalls.json</code></div>
      </div>
      <button class="secondary" onclick="loadFirewalls()">Actualizar</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tipo</th>
          <th>Alias</th>
          <th>Verificación SSL</th>
          <th>Apply/Reload</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="fw-table">
        <tr><td colspan="6" class="muted">Cargando...</td></tr>
      </tbody>
    </table>
  </section>
</section>

<section id="tab-plugins" class="tab-panel">
  <section class="card space">
    <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
      <div>
        <h2 style="margin:0 0 6px">Plugins</h2>
        <div class="muted">Activa y configura los plugins disponibles. ProxyTrap ahora permite ajustar severidad por dominio.</div>
      </div>
      <button class="secondary" onclick="loadPlugins()">Actualizar</button>
    </div>
    <div id="plugin-list" class="muted" style="margin-top:4px;">Cargando plugins...</div>
  </section>

  <div class="grid" style="grid-template-columns: 1.25fr 1fr; gap: 18px; align-items:start;">
    <div class="grid" style="grid-template-rows: auto auto auto; gap: 18px;">
      <form id="proxytrap-form" class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
          <div>
            <h3 style="margin-top:0">ProxyTrap</h3>
            <div class="muted">Servidor honeypot HTTP ligero.</div>
          </div>
          <span class="pill warn" style="display:none;" id="proxytrap-warning">Deshabilitado</span>
        </div>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="enabled" style="width:auto;" />
          Habilitar servidor ProxyTrap
        </label>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
          <div>
            <label>Puerto de escucha</label>
            <input name="port" type="number" min="1" max="65535" value="8081" />
          </div>
          <div>
            <label>Respuesta al ofensor</label>
            <select name="response_type" onchange="toggleCustomHtml()">
              <option value="silence">Silencio (204)</option>
              <option value="404">404 Not Found</option>
              <option value="custom">HTML personalizado</option>
            </select>
          </div>
          <div>
            <label>Severidad por defecto</label>
            <select name="default_severity">
              <option value="bajo">Bajo</option>
              <option value="medio">Medio</option>
              <option value="alto" selected>Alto</option>
            </select>
          </div>
        </div>
        <div id="custom-html-wrapper" style="display:none;">
          <label>HTML personalizado</label>
          <textarea name="custom_html" rows="4" placeholder="&lt;h1&gt;No permitido&lt;/h1&gt;"></textarea>
        </div>
        <button type="submit" style="margin-top:12px;">Guardar configuración</button>
        <div id="proxytrap-message" class="muted"></div>
      </form>

      <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
          <div>
            <h3 style="margin-top:0">Severidad por dominio</h3>
            <div class="muted">Define reglas específicas (soporta wildcard) y una opción comodín.</div>
          </div>
          <button class="secondary" onclick="resetProxytrapDefaults()">Restaurar defaults</button>
        </div>
        <form id="proxytrap-policy-form" class="grid" style="grid-template-columns: 2fr 1fr auto; gap: 10px; align-items:end;">
          <div>
            <label>Dominio / patrón</label>
            <input name="pattern" required placeholder="admin.ejemplo.com o *.intranet" />
          </div>
          <div>
            <label>Severidad</label>
            <select name="severity">
              <option value="bajo">Bajo</option>
              <option value="medio">Medio</option>
              <option value="alto" selected>Alto</option>
            </select>
          </div>
          <button type="submit">Añadir</button>
        </form>
        <div id="proxytrap-policy-message" class="muted" style="margin-top:6px;"></div>
        <div style="max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Patrón</th>
                <th>Severidad</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="proxytrap-policy-table">
              <tr><td colspan="3" class="muted">Sin reglas.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
          <div>
            <h3 style="margin-top:0">Port Detector</h3>
            <div class="muted">Escucha puertos TCP/UDP y registra conexiones entrantes.</div>
          </div>
          <span class="pill warn" style="display:none;" id="portdetector-warning">Deshabilitado</span>
        </div>
        <form id="portdetector-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" name="enabled" style="width:auto;" />
            Habilitar Port Detector
          </label>
          <div>
            <label>Severidad por defecto</label>
            <select name="default_severity">
              <option value="bajo">Bajo</option>
              <option value="medio" selected>Medio</option>
              <option value="alto">Alto</option>
            </select>
          </div>
          <button type="submit">Guardar configuración</button>
        </form>
        <div id="portdetector-message" class="muted" style="margin-top:4px;"></div>
        <div class="muted" style="margin-top:8px;">Configura reglas por puerto, lista o rango con severidades personalizadas.</div>
        <form id="portdetector-rule-form" class="grid" style="grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items:end; margin-top:10px;">
          <div>
            <label>Protocolo</label>
            <select name="protocol">
              <option value="tcp">TCP</option>
              <option value="udp">UDP</option>
            </select>
          </div>
          <div>
            <label>Tipo</label>
            <select name="mode" onchange="togglePortRange()">
              <option value="port">Puerto</option>
              <option value="list">Lista</option>
              <option value="range">Rango</option>
            </select>
          </div>
          <div id="portdetector-port-wrapper">
            <label>Puerto o lista (coma)</label>
            <input name="ports" placeholder="22,80,443" />
          </div>
          <div id="portdetector-range-wrapper" style="display:none; grid-column: span 1;">
            <label>Rango</label>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap:6px;">
              <input name="start" type="number" min="1" max="65535" placeholder="8000" />
              <input name="end" type="number" min="1" max="65535" placeholder="8100" />
            </div>
          </div>
          <div>
            <label>Severidad</label>
            <select name="severity">
              <option value="bajo">Bajo</option>
              <option value="medio" selected>Medio</option>
              <option value="alto">Alto</option>
            </select>
          </div>
          <button type="submit">Añadir</button>
        </form>
        <div id="portdetector-rule-message" class="muted" style="margin-top:6px;"></div>
        <div style="max-height:200px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Protocolo</th>
                <th>Detalle</th>
                <th>Severidad</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="portdetector-rule-table">
              <tr><td colspan="4" class="muted">Sin reglas.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
      <div class="flex space" style="align-items:flex-start;">
        <div>
          <h3 style="margin-top:0">Dominios más solicitados</h3>
          <div class="muted">Estadísticas recogidas por ProxyTrap.</div>
        </div>
        <button class="secondary" onclick="loadProxyTrapStats()">Refrescar</button>
      </div>
      <div style="max-height:320px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Dominio</th>
              <th>Solicitudes</th>
            </tr>
          </thead>
          <tbody id="proxytrap-stats">
            <tr><td colspan="2" class="muted">Sin datos.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<section id="tab-offenses" class="tab-panel">
  <section class="card">
    <div class="flex space" style="justify-content: space-between;">
      <div>
        <h2 style="margin:0">Ofensas reportadas</h2>
        <div class="muted">Listado de eventos recientes generados por los plugins o añadidos manualmente.</div>
      </div>
      <button class="secondary" onclick="loadOffenses()">Actualizar</button>
    </div>
    <div class="grid" style="grid-template-columns: 1.1fr 1fr; gap: 18px; align-items:start;">
      <form id="offense-form" class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <h3 style="margin-top:0">Crear ofensa manual</h3>
        <label>IP origen</label>
        <input name="source_ip" required placeholder="203.0.113.10" />
        <label>Descripción</label>
        <input name="description" required placeholder="Actividad sospechosa" />
        <label>Severidad</label>
        <select name="severity">
          <option value="bajo">Bajo</option>
          <option value="medio" selected>Medio</option>
          <option value="alto">Alto</option>
        </select>
        <button type="submit" style="margin-top:12px;">Registrar</button>
      </form>
      <form id="offense-block-form" class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
          <div>
            <h3 style="margin:0">Gestor de bloqueos</h3>
            <div class="muted">Bloquea la IP seleccionada directamente desde la lista de ofensas.</div>
          </div>
          <select id="offense-block-fw-select" class="block-fw-select" style="max-width:220px;"></select>
        </div>
        <label>IP a bloquear</label>
        <input name="ip" required placeholder="Selecciona una ofensa o escribe la IP" />
        <label>Motivo</label>
        <input name="reason" placeholder="Escalada manual desde ofensas" />
        <label>Duración (min)</label>
        <input name="duration_minutes" type="number" min="0" placeholder="60" />
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="sync_with_firewall" checked style="width:auto;" />
          Enviar bloqueo al firewall
        </label>
        <button type="submit" style="margin-top:12px;">Añadir a la lista</button>
        <div id="offense-block-message" class="muted"></div>
      </form>
    </div>
    <div style="overflow:auto; max-height:420px; margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>IP</th>
            <th>Descripción</th>
            <th>Severidad</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="offense-table">
          <tr><td colspan="5" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="card space" style="margin-top:16px;">
    <div class="flex space" style="justify-content: space-between; align-items:flex-start;">
      <div>
        <h2 style="margin:0">Reglas de escalado</h2>
        <div class="muted">Define cuándo una ofensa debe convertirse en bloqueo automático.</div>
        <div class="muted" style="margin-top:4px;">Los umbrales se aplican solo si se indica un valor y se evaluan con la condición <strong>&gt; X</strong>.</div>
      </div>
      <button class="secondary" onclick="loadRules()">Actualizar</button>
    </div>
    <div class="grid" style="grid-template-columns: 1.1fr 1fr; gap: 18px; align-items:start;">
      <form id="rule-form" class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <h3 style="margin-top:0">Añadir regla</h3>
        <label>Plugin</label>
        <input name="plugin" placeholder="auth" value="*" />
        <label>Severidad</label>
        <select name="severity">
          <option value="*" selected>Cualquiera</option>
          <option value="bajo">Bajo</option>
          <option value="medio">Medio</option>
          <option value="alto">Alto</option>
        </select>
        <label>Descripción (coincidencia)</label>
        <input name="description" placeholder="Texto a buscar" value="*" />
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
          <div>
            <label>Ofensas última hora (&gt;=)</label>
            <input name="min_last_hour" type="number" min="0" value="0" placeholder="> X" />
          </div>
          <div>
            <label>Ofensas totales (&gt;=)</label>
            <input name="min_total" type="number" min="0" value="0" placeholder="> X" />
          </div>
          <div>
            <label>Bloqueos totales (&gt;=)</label>
            <input name="min_blocks_total" type="number" min="0" value="0" placeholder="> X" />
          </div>
          <div>
            <label>Duración (min)</label>
            <input name="block_minutes" type="number" min="0" placeholder="60" />
          </div>
        </div>
        <button type="submit" style="margin-top:12px;">Guardar regla</button>
        <div id="rule-message" class="muted"></div>
      </form>

      <div style="max-height:360px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Plugin</th>
              <th>Severidad</th>
              <th>Descripción</th>
              <th>1h</th>
              <th>Total</th>
              <th>Bloqueos</th>
              <th>Duración</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rule-table">
            <tr><td colspan="8" class="muted">Sin reglas configuradas.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</section>

<section id="tab-blocks" class="tab-panel">
  <section class="card">
    <div class="flex space">
      <div>
        <h2 style="margin:0">Gestor de bloqueos</h2>
        <div class="muted">Consulta y modifica las listas de bloqueo locales y en el firewall.</div>
      </div>
      <div class="flex" style="gap:8px;">
        <select id="block-fw-select" class="block-fw-select" style="min-width:220px"></select>
        <button class="secondary" onclick="refreshBlocks()">Actualizar</button>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1.2fr 1fr; gap: 18px; margin-top:14px;">
      <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <h3 style="margin-top:0">Bloqueos activos en la base de datos</h3>
        <div class="muted" id="block-db-message"></div>
        <div style="max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
          <table>
            <thead>
              <tr>
                <th>IP</th>
                <th>Motivo</th>
                <th>Expira</th>
              </tr>
            </thead>
            <tbody id="block-db-table">
              <tr><td colspan="3" class="muted">Sin datos</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <h3 style="margin-top:0">Añadir entrada</h3>
        <form id="block-form" class="grid" style="grid-template-columns: 1fr; gap: 10px;">
          <div>
            <label>IP o red</label>
            <input name="ip" required placeholder="203.0.113.10" />
          </div>
          <div>
            <label>Motivo</label>
            <input name="reason" placeholder="Añadido manual" />
          </div>
          <div>
            <label>Duración (min)</label>
            <input name="duration_minutes" type="number" min="0" placeholder="60" />
          </div>
          <label style="display:flex; gap:8px; align-items:center;">
            <input type="checkbox" name="sync_with_firewall" checked style="width:auto;" />
            Enviar bloqueo al firewall
          </label>
          <button type="submit">Añadir a la lista</button>
          <div id="block-message" class="muted"></div>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="flex space" style="margin-bottom:8px;">
        <div>
          <h3 style="margin:0">Entradas en alias <span id="alias-label" class="muted"></span></h3>
          <div id="block-firewall-message" class="muted"></div>
        </div>
      </div>
      <div style="max-height:260px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>IP / Red</th>
              <th style="width:110px;"></th>
            </tr>
          </thead>
          <tbody id="block-table">
            <tr><td colspan="2" class="muted">Selecciona un firewall para listar las entradas.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="flex space" style="margin-bottom:8px;">
        <h3 style="margin:0">Historial reciente</h3>
        <button class="secondary" onclick="loadBlockHistory()">Actualizar</button>
      </div>
      <div style="max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Acción</th>
              <th>IP</th>
              <th>Motivo</th>
              <th>Momento</th>
            </tr>
          </thead>
          <tbody id="block-history-table">
            <tr><td colspan="4" class="muted">Cargando historial...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="flex space" style="margin-bottom:8px; gap:10px; flex-wrap: wrap; align-items: center;">
        <h3 style="margin:0">Regla de bloqueo en el firewall</h3>
        <div class="flex" style="gap:8px; flex-wrap: wrap; align-items: center;">
          <input id="block-rule-interface" placeholder="wan" style="max-width:120px;" />
          <button class="secondary" onclick="loadBlockRuleStats()">Consultar</button>
          <button class="secondary" onclick="flushFirewallStates()">Reset estados</button>
        </div>
      </div>
      <div id="block-rule-message" class="muted"></div>
      <div id="block-rule-stats" class="muted">Selecciona un firewall y pulsa Consultar para ver las estadísticas de la regla.</div>
    </div>
  </section>
</section>

<section id="tab-ips" class="tab-panel">
  <section class="card">
    <div class="flex space">
      <div>
        <h2 style="margin:0">Inspector de IP</h2>
        <div class="muted">Consulta los datos enriquecidos y el historial de ofensas/bloqueos.</div>
      </div>
      <button class="secondary" onclick="loadIps()">Actualizar</button>
    </div>
    <div class="grid" style="grid-template-columns: 1.3fr 1fr; gap: 18px; margin-top:12px;">
      <div style="max-height:420px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>IP</th>
              <th>Reverse DNS</th>
              <th>Ofensas</th>
              <th>Bloqueos</th>
              <th>Última vista</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="ip-table">
            <tr><td colspan="6" class="muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08); min-height:260px;">
        <h3 style="margin-top:0">Detalle</h3>
        <div id="ip-detail" class="muted">Selecciona una IP para ver su historial.</div>
      </div>
    </div>
  </section>
</section>

<section id="tab-whitelist" class="tab-panel">
  <section class="card">
    <div class="flex space">
      <div>
        <h2 style="margin:0">Whitelist</h2>
        <div class="muted">IPs o rangos que generan ofensas pero nunca bloqueos.</div>
      </div>
      <button class="secondary" onclick="loadWhitelist()">Actualizar</button>
    </div>
    <div class="grid" style="grid-template-columns: 1fr 1.1fr; gap: 18px; margin-top:12px;">
      <form id="whitelist-form" class="card" style="background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <h3 style="margin-top:0">Añadir a whitelist</h3>
        <label>IP o CIDR</label>
        <input name="cidr" required placeholder="198.51.100.0/24" />
        <label>Nota</label>
        <input name="note" placeholder="Proveedor de confianza" />
        <button type="submit" style="margin-top:12px;">Guardar</button>
        <div id="whitelist-message" class="muted"></div>
      </form>
      <div style="max-height:300px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px;">
        <table>
          <thead>
            <tr>
              <th>Entrada</th>
              <th>Nota</th>
              <th>Alta</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="whitelist-table">
            <tr><td colspan="4" class="muted">Sin entradas.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</section>

<div id="edit-modal" class="modal">
  <div class="panel">
    <div class="flex space" style="justify-content: space-between;">
      <h3 style="margin:0">Editar firewall</h3>
      <button type="button" class="secondary" onclick="closeEditModal()">Cerrar</button>
    </div>
    <form id="edit-form" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px;">
      <div>
        <label>Nombre</label>
        <input name="name" required />
      </div>
      <div>
        <label>Tipo</label>
        <select name="type">
          <option value="pfsense">pfSense (pfRest)</option>
          <option value="opnsense">OPNsense</option>
          <option value="ssh_iptables">SSH + iptables</option>
          <option value="dummy">Dummy</option>
        </select>
      </div>
      <div>
        <label>Base URL</label>
        <input name="base_url" placeholder="https://firewall.local" />
      </div>
      <div>
        <label>Alias</label>
        <input name="alias_name" />
      </div>
      <div>
        <label>API key</label>
        <input name="api_key" />
      </div>
      <div>
        <label>API secret</label>
        <input name="api_secret" />
      </div>
      <div>
        <label>Host SSH</label>
        <input name="ssh_host" />
      </div>
      <div>
        <label>Usuario SSH</label>
        <input name="ssh_user" />
      </div>
      <div>
        <label>Puerto SSH</label>
        <input name="ssh_port" type="number" min="1" max="65535" />
      </div>
      <div>
        <label>Ruta llave SSH</label>
        <input name="ssh_key_path" />
      </div>
      <div>
        <label>Timeout (s)</label>
        <input name="timeout" type="number" step="0.5" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px; flex-wrap: wrap;">
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="verify_ssl" style="width:auto;" />
          Verificar SSL
        </label>
        <label style="display:flex; gap:8px; align-items:center;">
          <input type="checkbox" name="apply_changes" style="width:auto;" />
          Recargar reglas tras cambios
        </label>
        <button type="submit">Guardar cambios</button>
        <button type="button" class="secondary" onclick="setupFirewall(event)">Setup Mimosa</button>
      </div>
    </form>
    <div id="edit-message" class="muted" style="margin-top:10px;"></div>
  </div>
</div>

<script>
let firewallsCache = [];
let selectedFirewallId = null;
let editingFirewallId = null;
let pluginsCache = [];
let proxytrapPolicies = [];
let editingPolicyIndex = null;
let portDetectorRules = [];
let editingPortRuleIndex = null;
let ipBlockChart = null;
const editModal = document.getElementById('edit-modal');
const editForm = document.getElementById('edit-form');
document.getElementById('block-rule-interface').value = 'wan';

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
  document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.toggle('active', panel.id === `tab-${tab}`));
  if (tab === 'blocks') refreshBlocks();
  if (tab === 'offenses') { loadOffenses(); loadRules(); }
  if (tab === 'ips') loadIps();
  if (tab === 'whitelist') loadWhitelist();
  if (tab === 'config') {
    loadBlockingSettings();
    loadFirewalls();
  }
  if (tab === 'plugins') {
    loadPlugins();
  }
}

function closeEditModal() {
  editingFirewallId = null;
  editModal.classList.remove('open');
  editForm.reset();
  const message = document.getElementById('edit-message');
  message.textContent = '';
  message.style.color = '';
}

function openEditModal(id) {
  const cfg = firewallsCache.find(item => item.id === id);
  if (!cfg) return;
  editingFirewallId = id;
  setFormValues(editForm, cfg);
  const message = document.getElementById('edit-message');
  message.textContent = '';
  message.style.color = '';
  editModal.classList.add('open');
}

async function loadBlockingSettings() {
  const res = await fetch('/api/settings/blocking');
  const data = await res.json();
  const form = document.getElementById('blocking-settings');
  form.default_duration_minutes.value = data.default_duration_minutes ?? 60;
  form.sync_interval_seconds.value = data.sync_interval_seconds ?? 300;
}

function defaultProxytrapPolicies() {
  return [
    { pattern: 'phpmyadmin.*', severity: 'alto' },
    { pattern: 'admin.*', severity: 'alto' },
    { pattern: '*.admin', severity: 'alto' },
    { pattern: 'cpanel.*', severity: 'alto' },
  ];
}

function defaultPortDetectorRules() {
  return [
    { protocol: 'tcp', ports: [21, 22, 23, 25, 53, 80, 110, 143, 443, 445, 993, 995, 3306, 5432, 6379, 8080], severity: 'alto' },
    { protocol: 'tcp', start: 5900, end: 5903, severity: 'medio' },
    { protocol: 'udp', ports: [53, 123], severity: 'medio' },
  ];
}

async function loadPlugins() {
  const res = await fetch('/api/plugins');
  const data = await res.json();
  pluginsCache = data;
  editingPolicyIndex = null;
  const list = document.getElementById('plugin-list');
  if (!data.length) {
    list.textContent = 'No hay plugins configurados.';
  } else {
    list.innerHTML = data
      .map(p => `<span class="pill" style="margin-right:8px;">${p.name} · ${p.enabled ? 'activo' : 'apagado'}</span>`)
      .join('');
  }

  const proxytrap = data.find(p => p.name === 'proxytrap');
  if (proxytrap && proxytrap.config) {
    setProxyTrapForm(proxytrap.config);
    toggleCustomHtml();
    const message = document.getElementById('proxytrap-policy-message');
    if (message) message.textContent = 'Reglas cargadas desde configuración.';
  }
  const portdetector = data.find(p => p.name === 'portdetector');
  if (portdetector && portdetector.config) {
    setPortDetectorForm(portdetector.config);
  }
  loadProxyTrapStats();
}

function setProxyTrapForm(config) {
  const form = document.getElementById('proxytrap-form');
  form.enabled.checked = Boolean(config.enabled);
  form.port.value = config.port ?? 8081;
  form.default_severity.value = config.default_severity || 'alto';
  form.response_type.value = config.response_type || '404';
  form.custom_html.value = config.custom_html || '';
  proxytrapPolicies = (config.domain_policies && config.domain_policies.length)
    ? config.domain_policies
    : defaultProxytrapPolicies();
  renderProxytrapPolicies();
  const warning = document.getElementById('proxytrap-warning');
  if (warning) {
    warning.style.display = form.enabled.checked ? 'none' : 'inline-flex';
  }
}

function renderProxytrapPolicies() {
  const tbody = document.getElementById('proxytrap-policy-table');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!proxytrapPolicies.length) {
    tbody.innerHTML = '<tr><td colspan="3" class="muted">Sin reglas.</td></tr>';
    return;
  }
  proxytrapPolicies.forEach((policy, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${policy.pattern}</td>
      <td>${policy.severity}</td>
      <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button class="secondary" type="button" onclick="editProxytrapPolicy(${index})">Editar</button>
        <button class="secondary" type="button" onclick="deleteProxytrapPolicy(${index})">Quitar</button>
      </td>`;
    tbody.appendChild(row);
  });
}

function resetProxytrapDefaults() {
  proxytrapPolicies = defaultProxytrapPolicies();
  editingPolicyIndex = null;
  renderProxytrapPolicies();
  const msg = document.getElementById('proxytrap-policy-message');
  if (msg) msg.textContent = 'Restauradas reglas por defecto (admin.*, phpmyadmin.*, cpanel.*).';
}

function setPortDetectorForm(config) {
  const form = document.getElementById('portdetector-form');
  form.enabled.checked = Boolean(config.enabled);
  form.default_severity.value = config.default_severity || 'medio';
  portDetectorRules = (config.rules && config.rules.length) ? config.rules : defaultPortDetectorRules();
  renderPortDetectorRules();
  const warning = document.getElementById('portdetector-warning');
  if (warning) warning.style.display = form.enabled.checked ? 'none' : 'inline-flex';
}

function renderPortDetectorRules() {
  const tbody = document.getElementById('portdetector-rule-table');
  if (!tbody) return;
  tbody.innerHTML = '';
  if (!portDetectorRules.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="muted">Sin reglas.</td></tr>';
    return;
  }
  portDetectorRules.forEach((rule, index) => {
    const detail = rule.port ? `Puerto ${rule.port}`
      : (rule.ports && rule.ports.length ? `Lista: ${rule.ports.join(', ')}`
      : (rule.start && rule.end ? `Rango ${rule.start}-${rule.end}` : ''));
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${rule.protocol || 'tcp'}</td>
      <td>${detail}</td>
      <td>${rule.severity || 'medio'}</td>
      <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button class="secondary" type="button" onclick="editPortDetectorRule(${index})">Editar</button>
        <button class="secondary" type="button" onclick="deletePortDetectorRule(${index})">Quitar</button>
      </td>`;
    tbody.appendChild(row);
  });
}

function togglePortRange() {
  const form = document.getElementById('portdetector-rule-form');
  const mode = form.mode.value;
  const rangeWrapper = document.getElementById('portdetector-range-wrapper');
  const portWrapper = document.getElementById('portdetector-port-wrapper');
  const portsInput = form.ports;
  const startInput = form.start;
  const endInput = form.end;
  if (mode === 'range') {
    rangeWrapper.style.display = 'block';
    portWrapper.style.display = 'none';
    portsInput.value = '';
  } else {
    rangeWrapper.style.display = 'none';
    portWrapper.style.display = 'block';
    startInput.value = '';
    endInput.value = '';
  }
}

function submitPortDetectorRule(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  const rule = {
    protocol: payload.protocol || 'tcp',
    severity: payload.severity || 'medio',
  };

  if (payload.mode === 'range') {
    rule.start = Number(payload.start || 0);
    rule.end = Number(payload.end || 0);
  } else if (payload.mode === 'list') {
    rule.ports = (payload.ports || '')
      .split(',')
      .map(p => Number(p.trim()))
      .filter(n => !Number.isNaN(n) && n > 0);
  } else {
    rule.port = Number(payload.ports || 0);
  }

  if (editingPortRuleIndex !== null) {
    portDetectorRules[editingPortRuleIndex] = rule;
  } else {
    portDetectorRules.push(rule);
  }
  editingPortRuleIndex = null;
  form.reset();
  form.mode.value = payload.mode || 'port';
  togglePortRange();
  renderPortDetectorRules();
  const msg = document.getElementById('portdetector-rule-message');
  if (msg) msg.textContent = 'Regla guardada. Recuerda pulsar "Guardar configuración" para aplicar.';
}

function editPortDetectorRule(index) {
  const rule = portDetectorRules[index];
  if (!rule) return;
  const form = document.getElementById('portdetector-rule-form');
  form.protocol.value = rule.protocol || 'tcp';
  form.severity.value = rule.severity || 'medio';
  if (rule.start && rule.end) {
    form.mode.value = 'range';
    form.start.value = rule.start;
    form.end.value = rule.end;
    form.ports.value = '';
  } else if (rule.ports && rule.ports.length) {
    form.mode.value = 'list';
    form.ports.value = rule.ports.join(',');
  } else {
    form.mode.value = 'port';
    form.ports.value = rule.port || '';
  }
  togglePortRange();
  editingPortRuleIndex = index;
  const msg = document.getElementById('portdetector-rule-message');
  if (msg) msg.textContent = 'Editando regla. Guarda para mantener los cambios.';
}

function deletePortDetectorRule(index) {
  portDetectorRules.splice(index, 1);
  editingPortRuleIndex = null;
  renderPortDetectorRules();
  const msg = document.getElementById('portdetector-rule-message');
  if (msg) msg.textContent = 'Regla eliminada localmente.';
}

async function submitPortDetector(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  payload.enabled = form.enabled.checked;
  payload.default_severity = payload.default_severity || 'medio';
  payload.rules = portDetectorRules;
  const message = document.getElementById('portdetector-message');
  message.style.color = '#94a3b8';
  message.textContent = 'Guardando...';
  try {
    const res = await fetch('/api/plugins/portdetector', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      message.textContent = payload.enabled ? 'Port Detector activo.' : 'Port Detector deshabilitado.';
      message.style.color = '#67e8f9';
      loadPlugins();
    } else {
      const data = await res.json();
      const detail = typeof data.detail === 'string'
        ? data.detail
        : (data.detail?.message || 'No se pudo guardar la configuración.');
      const failedPorts = Array.isArray(data.failed_ports)
        ? data.failed_ports
        : (Array.isArray(data.detail?.failed_ports) ? data.detail.failed_ports : []);
      if (failedPorts.length) {
        const list = failedPorts
          .map(entry => `<span style="color:#fca5a5;">${entry.port}</span>`)
          .join(', ');
        message.innerHTML = `${detail}<div style="margin-top:4px;">Puertos con error: ${list}</div>`;
      } else {
        message.textContent = detail;
      }
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al guardar la configuración.';
    message.style.color = '#fca5a5';
  }
}

function submitProxytrapPolicy(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  const entry = { pattern: (payload.pattern || '').trim(), severity: payload.severity || 'alto' };
  if (!entry.pattern) return;

  if (editingPolicyIndex !== null) {
    proxytrapPolicies[editingPolicyIndex] = entry;
  } else {
    proxytrapPolicies.push(entry);
  }
  editingPolicyIndex = null;
  form.reset();
  form.querySelector('button').textContent = 'Añadir';
  renderProxytrapPolicies();
  const msg = document.getElementById('proxytrap-policy-message');
  if (msg) msg.textContent = 'Regla guardada. Recuerda pulsar "Guardar configuración" para aplicar.';
}

function editProxytrapPolicy(index) {
  const policy = proxytrapPolicies[index];
  if (!policy) return;
  const form = document.getElementById('proxytrap-policy-form');
  form.pattern.value = policy.pattern;
  form.severity.value = policy.severity || 'alto';
  form.querySelector('button').textContent = 'Actualizar';
  editingPolicyIndex = index;
  const msg = document.getElementById('proxytrap-policy-message');
  if (msg) msg.textContent = 'Editando regla. Guarda para mantener los cambios.';
}

function deleteProxytrapPolicy(index) {
  proxytrapPolicies.splice(index, 1);
  editingPolicyIndex = null;
  renderProxytrapPolicies();
  const msg = document.getElementById('proxytrap-policy-message');
  if (msg) msg.textContent = 'Regla eliminada localmente.';
}

function toggleCustomHtml() {
  const form = document.getElementById('proxytrap-form');
  const wrapper = document.getElementById('custom-html-wrapper');
  wrapper.style.display = form.response_type.value === 'custom' ? 'block' : 'none';
}

async function submitProxytrap(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  payload.enabled = form.enabled.checked;
  payload.port = Number(payload.port || 8081);
  payload.domain_policies = proxytrapPolicies;
  if (payload.response_type !== 'custom') {
    payload.custom_html = null;
  }
  const message = document.getElementById('proxytrap-message');
  message.textContent = 'Guardando...';
  try {
    const res = await fetch('/api/plugins/proxytrap', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      message.textContent = payload.enabled ? 'ProxyTrap activo.' : 'ProxyTrap deshabilitado.';
      message.style.color = '#67e8f9';
      loadPlugins();
    } else {
      message.textContent = 'No se pudo guardar la configuración.';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al guardar la configuración.';
    message.style.color = '#fca5a5';
  }
}

async function loadProxyTrapStats() {
  const tbody = document.getElementById('proxytrap-stats');
  tbody.innerHTML = '<tr><td colspan="2" class="muted">Cargando...</td></tr>';
  const res = await fetch('/api/plugins/proxytrap/stats');
  if (!res.ok) {
    tbody.innerHTML = '<tr><td colspan="2" class="muted">No se pudieron cargar las estadísticas.</td></tr>';
    return;
  }
  const data = await res.json();
  setProxyTrapForm(data.config || {});
  toggleCustomHtml();
  const entries = data.top_domains || [];
  tbody.innerHTML = '';
  if (!entries.length) {
    tbody.innerHTML = '<tr><td colspan="2" class="muted">Sin datos registrados.</td></tr>';
    return;
  }
  entries.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${item.domain}</td><td>${item.hits}</td>`;
    tbody.appendChild(row);
  });
}

async function submitBlockingSettings(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  payload.default_duration_minutes = Number(payload.default_duration_minutes || 60);
  payload.sync_interval_seconds = Number(payload.sync_interval_seconds || 300);
  const res = await fetch('/api/settings/blocking', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const msg = document.getElementById('blocking-settings-message');
  if (res.ok) {
    msg.textContent = 'Configuración guardada';
    msg.style.color = '#67e8f9';
  } else {
    msg.textContent = 'No se pudo guardar la configuración';
    msg.style.color = '#fca5a5';
  }
}

async function loadFirewalls() {
  const res = await fetch('/api/firewalls');
  const data = await res.json();
  firewallsCache = data;
  const tbody = document.getElementById('fw-table');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="muted">No hay firewalls configurados.</td></tr>';
    renderBlockSelectors();
    return;
  }
  data.forEach(cfg => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${cfg.name}</td>
      <td>${cfg.type}</td>
      <td>${cfg.alias_name}</td>
      <td>${cfg.verify_ssl ? 'Sí' : 'No'}</td>
      <td>${cfg.apply_changes ? 'Sí' : 'No'}</td>
      <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button class="secondary" onclick="openEditModal('${cfg.id}')">Editar</button>
        <button class="secondary" onclick="deleteFirewall('${cfg.id}')">Eliminar</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  if (editingFirewallId && !data.find(cfg => cfg.id === editingFirewallId)) {
    closeEditModal();
  }

  renderBlockSelectors();
}

async function deleteFirewall(id) {
  await fetch(`/api/firewalls/${id}`, { method: 'DELETE' });
  if (editingFirewallId === id) {
    closeEditModal();
  }
  loadFirewalls();
}

async function submitForm(event) {
  event.preventDefault();
  const form = event.target;
  const payload = buildPayload(form);
  const res = await fetch('/api/firewalls', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const message = document.getElementById('form-message');
  if (res.ok) {
    message.textContent = 'Guardado correctamente';
    message.style.color = '#67e8f9';
    form.reset();
    form.alias_name.value = 'mimosa_blocklist';
    form.timeout.value = '5';
    form.verify_ssl.checked = true;
    form.apply_changes.checked = true;
    loadFirewalls();
  } else {
    message.textContent = 'Error al guardar';
    message.style.color = '#fca5a5';
  }
}

function buildPayload(form) {
  const payload = Object.fromEntries(new FormData(form));
  payload.verify_ssl = form.verify_ssl.checked;
  payload.apply_changes = form.apply_changes ? form.apply_changes.checked : true;
  payload.timeout = parseFloat(payload.timeout || '5');
  payload.ssh_port = payload.ssh_port ? Number(payload.ssh_port) : 22;
  return payload;
}

function setFormValues(form, cfg) {
  form.name.value = cfg.name || '';
  form.type.value = cfg.type || 'pfsense';
  form.base_url.value = cfg.base_url || '';
  form.alias_name.value = cfg.alias_name || '';
  form.api_key.value = cfg.api_key || '';
  form.api_secret.value = cfg.api_secret || '';
  form.ssh_host.value = cfg.ssh_host || '';
  form.ssh_user.value = cfg.ssh_user || '';
  form.ssh_port.value = cfg.ssh_port ?? 22;
  form.ssh_key_path.value = cfg.ssh_key_path || '';
  form.timeout.value = cfg.timeout ?? 5;
  form.verify_ssl.checked = Boolean(cfg.verify_ssl);
  if (form.apply_changes) {
    form.apply_changes.checked = cfg.apply_changes ?? true;
  }
}

async function testConnection(event) {
  const form = event.target.form;
  const payload = buildPayload(form);
  const message = document.getElementById('form-message');
  message.textContent = 'Probando conexión...';
  message.style.color = '';
  try {
    const res = await fetch('/api/firewalls/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (res.ok && data.online) {
      message.textContent = `Conexión OK (${data.type})`;
      message.style.color = '#67e8f9';
    } else {
      message.textContent = data.message || 'No se pudo establecer conexión';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al probar la conexión';
    message.style.color = '#fca5a5';
  }
}

async function submitEdit(event) {
  event.preventDefault();
  if (!editingFirewallId) return;
  const payload = buildPayload(event.target);
  const message = document.getElementById('edit-message');
  message.textContent = 'Guardando...';
  message.style.color = '';
  try {
    const res = await fetch(`/api/firewalls/${editingFirewallId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      message.textContent = 'Firewall actualizado correctamente';
      message.style.color = '#67e8f9';
      await loadFirewalls();
    } else {
      message.textContent = data.detail || 'No se pudo actualizar';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error al actualizar el firewall';
    message.style.color = '#fca5a5';
  }
}

async function setupFirewall(event) {
  if (event) event.preventDefault();
  if (!editingFirewallId) return;
  const message = document.getElementById('edit-message');
  message.textContent = 'Preparando alias y listas...';
  message.style.color = '';
  try {
    const res = await fetch(`/api/firewalls/${editingFirewallId}/setup`, { method: 'POST' });
    const data = await res.json().catch(() => ({}));
    if (res.ok) {
      message.textContent = data.message || 'Setup completado';
      message.style.color = '#67e8f9';
    } else {
      message.textContent = data.detail || 'No se pudo preparar el firewall';
      message.style.color = '#fca5a5';
    }
  } catch (error) {
    message.textContent = 'Error durante el setup';
    message.style.color = '#fca5a5';
  }
}

function renderBlockSelectors() {
  const selects = document.querySelectorAll('.block-fw-select');
  selects.forEach(select => { select.innerHTML = ''; });
  if (!firewallsCache.length) {
    selects.forEach(select => {
      select.innerHTML = '<option value="" disabled selected>Configura un firewall primero</option>';
    });
    updateBlockTableMessage('Añade un firewall para gestionar bloqueos.');
    document.getElementById('offense-block-message').textContent = 'Configura un firewall para bloquear desde aquí.';
    selectedFirewallId = null;
    return;
  }
  if (!selectedFirewallId) {
    selectedFirewallId = firewallsCache[0].id;
  }
  selects.forEach(select => {
    firewallsCache.forEach(cfg => {
      const opt = document.createElement('option');
      opt.value = cfg.id;
      opt.textContent = `${cfg.name} (${cfg.type})`;
      select.appendChild(opt);
    });
    select.value = selectedFirewallId;
  });
  refreshBlocks();
}

function updateBlockTableMessage(message) {
  const tbody = document.getElementById('block-table');
  tbody.innerHTML = `<tr><td colspan="2" class="muted">${message}</td></tr>`;
}

async function refreshBlocks() {
  loadDatabaseBlocks();
  loadBlockHistory();
  loadBlockRuleStats();
  if (!selectedFirewallId) {
    updateBlockTableMessage('Configura un firewall para ver las listas.');
    return;
  }
  updateBlockTableMessage('Cargando entradas...');
  const messageEl = document.getElementById('block-firewall-message');
  messageEl.textContent = '';
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks`);
    if (!res.ok) {
      updateBlockTableMessage('No se pudo obtener la lista.');
      return;
    }
    const data = await res.json();
    document.getElementById('alias-label').textContent = data.alias ? `(${data.alias})` : '';
    const tbody = document.getElementById('block-table');
    tbody.innerHTML = '';
    if (!data.items || !data.items.length) {
      updateBlockTableMessage('No hay entradas en la lista.');
      return;
    }
    data.items.forEach(ip => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ip}</td>
        <td style="text-align:right"><button class="secondary" onclick="removeBlock('${ip}')">Eliminar</button></td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    updateBlockTableMessage('Error al cargar las entradas.');
  }
}

async function loadDatabaseBlocks() {
  try {
    const res = await fetch('/api/blocks');
    const blocks = await res.json();
    const tbody = document.getElementById('block-db-table');
    tbody.innerHTML = '';
    if (!blocks.length) {
      tbody.innerHTML = '<tr><td colspan="3" class="muted">No hay bloqueos activos.</td></tr>';
      return;
    }
    blocks.forEach(entry => {
      const expires = entry.expires_at ? new Date(entry.expires_at).toLocaleString() : 'Sin caducidad';
      const row = document.createElement('tr');
      row.innerHTML = `<td>${entry.ip}</td><td>${entry.reason}</td><td>${expires}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    document.getElementById('block-db-table').innerHTML = '<tr><td colspan="3" class="muted">Error al cargar los bloqueos.</td></tr>';
  }
}

async function loadBlockHistory() {
  try {
    const res = await fetch('/api/blocks/history');
    const events = await res.json();
    const tbody = document.getElementById('block-history-table');
    tbody.innerHTML = '';
    if (!events.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="muted">Sin actividad reciente.</td></tr>';
      return;
    }
    events.forEach(event => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${event.action}</td>
        <td>${event.ip}</td>
        <td>${event.reason || '-'}</td>
        <td>${new Date(event.at).toLocaleString()}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    const tbody = document.getElementById('block-history-table');
    tbody.innerHTML = '<tr><td colspan="4" class="muted">No se pudo cargar el historial.</td></tr>';
  }
}

function updateBlockRuleMessage(message, color = '') {
  const msg = document.getElementById('block-rule-message');
  msg.textContent = message;
  msg.style.color = color;
}

async function loadBlockRuleStats() {
  const statsEl = document.getElementById('block-rule-stats');
  const interfaceInput = document.getElementById('block-rule-interface');
  const iface = (interfaceInput?.value || 'wan').trim() || 'wan';
  if (interfaceInput && !interfaceInput.value) interfaceInput.value = iface;
  updateBlockRuleMessage('');

  if (!selectedFirewallId) {
    statsEl.textContent = 'Configura un firewall para consultar la regla.';
    return;
  }

  statsEl.textContent = 'Consultando datos de la regla...';
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/block_rule_stats?interface=${encodeURIComponent(iface)}`);
    const data = await res.json();
    if (!res.ok) {
      updateBlockRuleMessage(data.detail || 'No se pudieron recuperar las estadísticas.', '#fca5a5');
      statsEl.textContent = '';
      return;
    }
    if (data.supported === false) {
      updateBlockRuleMessage(data.message || 'Regla no soportada en este firewall.', '#fca5a5');
      statsEl.textContent = '';
      return;
    }

    const ruleLabel = data.rule || 'Regla no localizada';
    const states = typeof data.states === 'number' ? data.states : 0;
    const matches = data.matches ?? 0;
    const uuid = data.uuid || 'Desconocido';

    statsEl.innerHTML = `
      <div><strong>Alias:</strong> ${data.alias || '-'} (${data.interface})</div>
      <div><strong>Regla:</strong> ${ruleLabel}</div>
      <div><strong>UUID:</strong> ${uuid}</div>
      <div><strong>Estados activos:</strong> ${states}</div>
      <div class="muted">Coincidencias encontradas: ${matches}</div>
    `;
  } catch (error) {
    updateBlockRuleMessage('Error al consultar las estadísticas de la regla.', '#fca5a5');
    statsEl.textContent = '';
  }
}

async function flushFirewallStates() {
  if (!selectedFirewallId) {
    updateBlockRuleMessage('Selecciona un firewall antes de resetear estados.', '#fca5a5');
    return;
  }
  updateBlockRuleMessage('Reseteando estados activos...');
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/flush_states`, { method: 'POST' });
    const data = await res.json();
    if (!res.ok) {
      updateBlockRuleMessage(data.detail || 'No se pudieron limpiar los estados.', '#fca5a5');
      return;
    }
    updateBlockRuleMessage(data.message || data.status || 'Estados reiniciados.', '#c0e2ff');
    loadBlockRuleStats();
  } catch (error) {
    updateBlockRuleMessage('Error al resetear los estados.', '#fca5a5');
  }
}

function handleFirewallChange(event) {
  selectedFirewallId = event.target.value;
  document.querySelectorAll('.block-fw-select').forEach(select => {
    if (select.value !== selectedFirewallId) {
      select.value = selectedFirewallId;
    }
  });
  refreshBlocks();
}

async function submitBlockForm(event, messageId) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  const syncCheckbox = form.querySelector('input[name="sync_with_firewall"]');
  payload.sync_with_firewall = syncCheckbox ? !!syncCheckbox.checked : true;
  const message = document.getElementById(messageId);
  message.textContent = '';
  if (!selectedFirewallId) {
    message.textContent = 'Selecciona o configura un firewall antes de bloquear.';
    message.style.color = '#fca5a5';
    return;
  }
  if (payload.duration_minutes === '') {
    delete payload.duration_minutes;
  } else {
    payload.duration_minutes = Number(payload.duration_minutes);
  }
  try {
    const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      const data = await res.json();
      form.reset();
      message.textContent = data.synced_with_firewall
        ? 'Entrada añadida y enviada al firewall.'
        : 'Entrada guardada solo en la base de datos.';
      refreshBlocks();
    } else {
      message.textContent = 'No se pudo añadir la entrada.';
    }
  } catch (error) {
    message.textContent = 'Error al añadir la entrada.';
  }
}

function addBlock(event) {
  return submitBlockForm(event, 'block-message');
}

function addBlockFromOffense(event) {
  return submitBlockForm(event, 'offense-block-message');
}

async function removeBlock(ip) {
  if (!selectedFirewallId) return;
  const res = await fetch(`/api/firewalls/${selectedFirewallId}/blocks/${encodeURIComponent(ip)}`, { method: 'DELETE' });
  if (res.ok) {
    refreshBlocks();
  } else {
    document.getElementById('block-firewall-message').textContent = 'No se pudo eliminar la entrada.';
  }
}

async function loadOffenses() {
  const res = await fetch('/api/offenses?limit=100');
  const data = await res.json();
  const tbody = document.getElementById('offense-table');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="muted">No hay ofensas registradas.</td></tr>';
    return;
  }
  data.forEach(item => {
    const row = document.createElement('tr');
    const safeReason = JSON.stringify(item.description || '');
    row.innerHTML = `
      <td>${new Date(item.created_at).toLocaleString()}</td>
      <td>${item.source_ip}</td>
      <td>${item.description}</td>
      <td>${item.severity}</td>
      <td style="text-align:right"><button class="secondary" onclick="prefillBlockFromOffense('${item.source_ip}', ${safeReason})">Bloquear</button></td>
    `;
    tbody.appendChild(row);
  });
}

async function loadRules() {
  const tbody = document.getElementById('rule-table');
  const message = document.getElementById('rule-message');
  tbody.innerHTML = '<tr><td colspan="8" class="muted">Cargando...</td></tr>';
  message.textContent = '';
  const res = await fetch('/api/rules');
  if (!res.ok) {
    tbody.innerHTML = '<tr><td colspan="8" class="muted">No se pudieron cargar las reglas.</td></tr>';
    return;
  }
  const data = await res.json();
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="8" class="muted">Sin reglas configuradas.</td></tr>';
    return;
  }
  data.forEach(rule => {
    const row = document.createElement('tr');
    const duration = rule.block_minutes === null || rule.block_minutes === undefined ? 'Por defecto' : `${rule.block_minutes}m`;
    row.innerHTML = `
      <td>${rule.plugin}</td>
      <td>${rule.severity}</td>
      <td>${rule.description}</td>
      <td>${rule.min_last_hour}</td>
      <td>${rule.min_total}</td>
      <td>${rule.min_blocks_total}</td>
      <td>${duration}</td>
      <td style="text-align:right"><button class="secondary" onclick="deleteRule(${rule.id})">Eliminar</button></td>
    `;
    tbody.appendChild(row);
  });
}

async function submitRule(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  ['min_last_hour', 'min_total', 'min_blocks_total', 'block_minutes'].forEach(key => {
    if (payload[key] === '') {
      delete payload[key];
      return;
    }
    payload[key] = Number(payload[key]);
  });
  const res = await fetch('/api/rules', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const message = document.getElementById('rule-message');
  if (res.ok) {
    message.textContent = 'Regla guardada correctamente';
    message.style.color = '#67e8f9';
    form.reset();
    form.plugin.value = '*';
    form.description.value = '*';
    form.min_last_hour.value = 0;
    form.min_total.value = 0;
    form.min_blocks_total.value = 0;
    loadRules();
  } else {
    message.textContent = 'No se pudo guardar la regla';
    message.style.color = '#fca5a5';
  }
}

async function deleteRule(ruleId) {
  await fetch(`/api/rules/${ruleId}`, { method: 'DELETE' });
  loadRules();
}

function prefillBlockFromOffense(ip, description) {
  const form = document.getElementById('offense-block-form');
  if (!form) return;
  const offenseIp = form.querySelector('input[name="ip"]');
  const offenseReason = form.querySelector('input[name="reason"]');
  if (offenseIp) offenseIp.value = ip;
  if (offenseReason) offenseReason.value = description || 'Escalada manual desde ofensas';
  const message = document.getElementById('offense-block-message');
  message.textContent = `IP ${ip} lista para bloquear.`;
  const mainForm = document.getElementById('block-form');
  if (mainForm) {
    const mainIp = mainForm.querySelector('input[name="ip"]');
    const mainReason = mainForm.querySelector('input[name="reason"]');
    if (mainIp) mainIp.value = ip;
    if (mainReason) mainReason.value = description || 'Escalada manual desde ofensas';
  }
  const mainMessage = document.getElementById('block-message');
  if (mainMessage) {
    mainMessage.textContent = `IP ${ip} copiada al gestor de bloqueos.`;
  }
}

async function submitOffense(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  const res = await fetch('/api/offenses', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  if (res.ok) {
    form.reset();
    loadOffenses();
  }
}

async function loadIps() {
  const res = await fetch('/api/ips');
  const data = await res.json();
  const tbody = document.getElementById('ip-table');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="muted">No hay IPs registradas aún.</td></tr>';
    return;
  }
  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.ip}</td>
      <td>${item.reverse_dns || '-'}</td>
      <td>${item.offenses}</td>
      <td>${item.blocks}</td>
      <td>${new Date(item.last_seen).toLocaleString()}</td>
      <td style="text-align:right; display:flex; gap:8px; justify-content:flex-end;">
        <button class="secondary" onclick="showIpDetail('${item.ip}')">Ver</button>
        <button class="secondary" onclick="refreshIp('${item.ip}')">Refrescar</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

async function showIpDetail(ip) {
  const res = await fetch(`/api/ips/${encodeURIComponent(ip)}`);
  const data = await res.json();
  if (!res.ok) return;
  const detail = document.getElementById('ip-detail');
  const profile = data.profile;
  const offenses = data.offenses || [];
  const blocks = data.blocks || [];
  const blockGroups = blocks.reduce((acc, block) => {
    const key = block.source || 'desconocido';
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
  const blockTypeSummary = Object.entries(blockGroups)
    .map(([source, count]) => `${source}: ${count}`)
    .join(' · ');
  const latestBlock = blocks[0] ? new Date(blocks[0].created_at).toLocaleString() : 'sin registros';
  detail.innerHTML = `
    <div><strong>${profile.ip}</strong></div>
    <div class="muted">Reverse DNS: ${profile.reverse_dns || 'n/d'}</div>
    <div class="muted">Geo: ${profile.geo || 'pendiente'} · Whois: ${profile.whois || 'pendiente'}</div>
    <div class="muted">Primera vista: ${new Date(profile.first_seen).toLocaleString()}</div>
    <div class="muted">Última vista: ${new Date(profile.last_seen).toLocaleString()}</div>
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; margin:12px 0;">
      <div class="card" style="padding:12px; background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="muted">Estadísticas rápidas</div>
        <div style="font-weight:700;">${offenses.length} ofensas · ${blocks.length} bloqueos</div>
        <div class="muted">Último bloqueo: ${latestBlock}</div>
        <div class="muted">Tipos: ${blockTypeSummary || 'Sin bloqueos registrados'}</div>
      </div>
      <div class="card" style="padding:12px; background: rgba(255,255,255,.02); border:1px dashed rgba(255,255,255,.08);">
        <div class="muted" style="margin-bottom:6px;">Distribución de bloqueos</div>
        <canvas id="ip-block-chart" height="140"></canvas>
        <div id="ip-block-chart-empty" class="muted" style="display:none;">Sin bloqueos para graficar.</div>
      </div>
    </div>
    <h4>Ofensas</h4>
    <ul style="max-height:120px; overflow:auto; padding-left:18px;">
      ${offenses.map(o => `<li>${new Date(o.created_at).toLocaleString()} · ${o.description}</li>`).join('') || '<li class="muted">Sin ofensas registradas</li>'}
    </ul>
    <h4>Bloqueos</h4>
    <ul style="max-height:120px; overflow:auto; padding-left:18px;">
      ${blocks.map(b => `<li>${new Date(b.created_at).toLocaleString()} · ${b.reason}</li>`).join('') || '<li class="muted">Sin bloqueos</li>'}
    </ul>
  `;
  renderIpBlockChart(blocks);
}

function renderIpBlockChart(blocks) {
  const canvas = document.getElementById('ip-block-chart');
  const emptyState = document.getElementById('ip-block-chart-empty');
  if (!canvas) return;
  if (ipBlockChart) {
    ipBlockChart.destroy();
    ipBlockChart = null;
  }
  const grouped = blocks.reduce((acc, block) => {
    const key = block.source || 'desconocido';
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
  const labels = Object.keys(grouped);
  const values = Object.values(grouped);

  if (!labels.length) {
    canvas.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  if (emptyState) emptyState.style.display = 'none';

  const colors = ['#38bdf8', '#22c55e', '#fbbf24', '#f472b6', '#a78bfa', '#60a5fa'];
  ipBlockChart = new Chart(canvas.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{ data: values, backgroundColor: labels.map((_, idx) => colors[idx % colors.length]) }]
    },
    options: {
      plugins: { legend: { labels: { color: '#e2e8f0' } } }
    }
  });
}

async function refreshIp(ip) {
  await fetch(`/api/ips/${encodeURIComponent(ip)}/refresh`, { method: 'POST' });
  loadIps();
  showIpDetail(ip);
}

async function loadWhitelist() {
  const res = await fetch('/api/whitelist');
  const data = await res.json();
  const tbody = document.getElementById('whitelist-table');
  tbody.innerHTML = '';
  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="4" class="muted">No hay entradas en la whitelist.</td></tr>';
    return;
  }
  data.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.cidr}</td>
      <td>${item.note || '-'}</td>
      <td>${new Date(item.created_at).toLocaleString()}</td>
      <td style="text-align:right"><button class="secondary" onclick="deleteWhitelist(${item.id})">Eliminar</button></td>
    `;
    tbody.appendChild(row);
  });
}

async function submitWhitelist(event) {
  event.preventDefault();
  const form = event.target;
  const payload = Object.fromEntries(new FormData(form));
  const res = await fetch('/api/whitelist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const message = document.getElementById('whitelist-message');
  if (res.ok) {
    message.textContent = 'Guardado';
    message.style.color = '#67e8f9';
    form.reset();
    loadWhitelist();
  } else {
    message.textContent = 'No se pudo guardar';
    message.style.color = '#fca5a5';
  }
}

async function deleteWhitelist(id) {
  await fetch(`/api/whitelist/${id}`, { method: 'DELETE' });
  loadWhitelist();
}

// Event bindings
document.getElementById('block-form').addEventListener('submit', addBlock);
document.getElementById('offense-block-form').addEventListener('submit', addBlockFromOffense);
document.getElementById('firewall-form').addEventListener('submit', submitForm);
document.getElementById('offense-form').addEventListener('submit', submitOffense);
document.getElementById('rule-form').addEventListener('submit', submitRule);
document.getElementById('whitelist-form').addEventListener('submit', submitWhitelist);
document.getElementById('blocking-settings').addEventListener('submit', submitBlockingSettings);
document.getElementById('proxytrap-form').addEventListener('submit', submitProxytrap);
document.getElementById('proxytrap-policy-form').addEventListener('submit', submitProxytrapPolicy);
document.getElementById('portdetector-form').addEventListener('submit', submitPortDetector);
document.getElementById('portdetector-rule-form').addEventListener('submit', submitPortDetectorRule);
document.querySelectorAll('.block-fw-select').forEach(select => {
  select.addEventListener('change', handleFirewallChange);
});
togglePortRange();
editForm.addEventListener('submit', submitEdit);
editModal.addEventListener('click', (event) => {
  if (event.target === editModal) {
    closeEditModal();
  }
});

// Cargas iniciales
loadBlockingSettings();
loadFirewalls();
loadDatabaseBlocks();
loadBlockHistory();
loadOffenses();
loadRules();
loadIps();
loadWhitelist();
loadPlugins();
</script>
{% endblock %}
