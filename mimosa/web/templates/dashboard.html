{% extends "base.html" %}
{% block content %}
<style>
  .dash-tabs { display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
  .dash-tab { background: rgba(15,23,42,.4); color: var(--text); border: 1px solid rgba(255,255,255,.12); padding: 8px 14px; border-radius: 999px; cursor:pointer; font-weight:700; transition: transform .2s ease, border-color .2s ease; }
  .dash-tab.active { background: linear-gradient(120deg, var(--accent), var(--accent-2)); color:#082f49; border-color: transparent; box-shadow: 0 12px 30px rgba(34,211,238,.2); }
  .dash-panel { display:none; }
  .dash-panel.active { display:block; }
  .dash-grid { display: grid; gap: 16px; }
  .dash-grid.cols-3 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
  .dash-grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
  .dash-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .dash-table th, .dash-table td { padding: 6px 8px; text-align: left; }
  .dash-table th { color: var(--muted); text-transform: uppercase; letter-spacing: .04em; font-size: 11px; }
  .tag { display:inline-flex; align-items:center; gap:6px; font-size:11px; font-weight:700; padding:2px 8px; border-radius:999px; }
  .tag.ok { background: rgba(34,197,94,.18); color:#bbf7d0; }
  .tag.warn { background: rgba(245,158,11,.18); color:#fef3c7; }
  .tag.bad { background: rgba(248,113,113,.18); color:#fecaca; }
  .tag.info { background: rgba(34,211,238,.18); color:#cffafe; }
  .heatmap-card { background: rgba(17,24,39,.75); border-radius: 16px; padding: 16px; border: 1px solid rgba(255,255,255,.05); }
  .heatmap-grid { display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 14px; align-items: start; margin-top: 12px; }
  .heatmap-map { width: 100%; height: 380px; border-radius: 12px; border: 1px solid rgba(255,255,255,.06); overflow: hidden; }
  .heatmap-rank { border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 12px; background: rgba(15,23,42,.6); }
  .heatmap-rank table { width: 100%; border-collapse: collapse; }
  .heatmap-rank th, .heatmap-rank td { padding: 6px 8px; font-size: 12px; text-align: left; }
  .heatmap-flag { font-size: 16px; }
  .heatmap-label { background: rgba(15,23,42,.85); color: #fde68a; border: 1px solid rgba(245,158,11,.6); border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: 700; box-shadow: 0 6px 18px rgba(0,0,0,.35); }
  @media (max-width: 900px) { .heatmap-grid { grid-template-columns: 1fr; } }
  @media (max-width: 640px) { .heatmap-map { height: 280px; } }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

<div class="dash-tabs">
  <button class="dash-tab active" data-tab="overview" onclick="switchDashTab('overview')">Resumen</button>
  <button class="dash-tab" data-tab="map" onclick="switchDashTab('map')">Mapa</button>
</div>

<section id="dash-overview" class="dash-panel active">
<section class="grid stats space">
  <div class="card">
    <h2>Ofensas totales (&gt;=)</h2>
    <div class="number" id="offenses-total">0</div>
    <div class="muted">Acumulado en base de datos</div>
  </div>
  <div class="card">
    <h2>Últimos 7 días</h2>
    <div class="number" id="offenses-7d">0</div>
    <div class="muted">Eventos recientes</div>
  </div>
  <div class="card">
    <h2>Últimas 24h</h2>
    <div class="number" id="offenses-24h">0</div>
    <div class="muted">Actividad de ayer a hoy</div>
  </div>
  <div class="card">
    <h2>Última hora</h2>
    <div class="number" id="offenses-1h">0</div>
    <div class="muted">Picos recientes</div>
  </div>
</section>

<section class="grid stats space">
  <div class="card">
    <h2>Bloqueos totales</h2>
    <div class="number" id="blocks-total">0</div>
    <div class="muted">Histórico acumulado</div>
  </div>
  <div class="card">
    <h2>Bloqueos últimos 7 días</h2>
    <div class="number" id="blocks-7d">0</div>
    <div class="muted">Eventos recientes</div>
  </div>
  <div class="card">
    <h2>Bloqueos últimas 24h</h2>
    <div class="number" id="blocks-24h">0</div>
    <div class="muted">Actividad de ayer a hoy</div>
  </div>
  <div class="card">
    <h2>Bloqueos última hora</h2>
    <div class="number" id="blocks-1h">0</div>
    <div class="muted">Ataques en curso</div>
  </div>
  <div class="card">
    <h2>Bloqueos activos</h2>
    <div class="number" id="blocks-current">0</div>
    <div class="muted">IPs en lista negra</div>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Ofensas</h2>
        <div class="muted">Distribución por ventana temporal</div>
      </div>
      <select id="offenses-range-selector" style="max-width: 160px;">
        <option value="7d">Últimos 7 días</option>
        <option value="24h">Últimas 24 horas</option>
        <option value="1h">Última hora</option>
      </select>
    </div>
    <canvas id="offenses-chart" height="200"></canvas>
  </div>
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Bloqueos</h2>
        <div class="muted">Histórico registrado</div>
      </div>
      <select id="blocks-range-selector" style="max-width: 160px;">
        <option value="7d">Últimos 7 días</option>
        <option value="24h">Últimas 24 horas</option>
        <option value="1h">Última hora</option>
      </select>
    </div>
    <canvas id="blocks-chart" height="200"></canvas>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Ratio bloqueo/ofensa</h2>
        <div class="muted">Últimas 24 horas</div>
      </div>
    </div>
    <canvas id="ratio-chart" height="200"></canvas>
  </div>
  <div class="chart">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin: 0">Actividad en vivo</h2>
        <div class="muted">Últimas ofensas recibidas</div>
      </div>
      <select id="live-feed-filter" style="max-width: 180px;">
        <option value="">Todas</option>
        <option value="mimosanpm">MimosaNPM</option>
        <option value="proxytrap">ProxyTrap</option>
        <option value="portdetector">Port Detector</option>
      </select>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>Tiempo</th>
            <th>IP</th>
            <th>Detalle</th>
          </tr>
        </thead>
        <tbody id="live-feed-table">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="dash-grid cols-3" style="margin-top: 16px;">
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Top IPs peligrosas</h2>
        <div class="muted">Score basado en ofensas + bloqueos</div>
      </div>
      <button class="secondary" onclick="loadTopIps()">Refrescar</button>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>IP</th>
            <th>Score</th>
            <th>Ofensas</th>
            <th>Bloqueos</th>
          </tr>
        </thead>
        <tbody id="top-ips-table">
          <tr><td colspan="4" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Bloqueos por expirar</h2>
        <div class="muted">Próximos 60 minutos</div>
      </div>
      <button class="secondary" onclick="loadExpiringBlocks()">Refrescar</button>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>IP</th>
            <th>Min</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody id="expiring-blocks-table">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Eficacia de reglas</h2>
        <div class="muted">Motivos de bloqueo más frecuentes</div>
      </div>
      <button class="secondary" onclick="loadBlockReasons()">Refrescar</button>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>Motivo</th>
            <th>Bloqueos</th>
          </tr>
        </thead>
        <tbody id="block-reasons-table">
          <tr><td colspan="2" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="dash-grid cols-2" style="margin-top: 16px;">
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Estado de firewalls</h2>
        <div class="muted">Disponibilidad y latencia</div>
      </div>
      <button class="secondary" onclick="loadDashboardHealth()">Refrescar</button>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>Firewall</th>
            <th>Estado</th>
            <th>Latencia</th>
          </tr>
        </thead>
        <tbody id="firewall-health-table">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Estado de plugins</h2>
        <div class="muted">Última actividad (24h)</div>
      </div>
      <button class="secondary" onclick="loadDashboardHealth()">Refrescar</button>
    </div>
    <div style="max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:10px;">
      <table class="dash-table">
        <thead>
          <tr>
            <th>Plugin</th>
            <th>Estado</th>
            <th>Eventos 24h</th>
          </tr>
        </thead>
        <tbody id="plugin-health-table">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 18px; align-items:start;">
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">ProxyTrap</h2>
        <div class="muted">Dominios más solicitados</div>
      </div>
      <button class="secondary" onclick="loadProxyTrapStats()">Refrescar</button>
    </div>
    <div style="max-height:300px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Dominio</th>
            <th>Solicitudes</th>
          </tr>
        </thead>
        <tbody id="proxytrap-stats" aria-live="polite">
          <tr><td colspan="2" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Port Detector</h2>
        <div class="muted">Puertos más solicitados</div>
      </div>
      <button class="secondary" onclick="loadPortDetectorStats()">Refrescar</button>
    </div>
    <div style="max-height:300px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Puerto</th>
            <th>Protocolo</th>
            <th>Solicitudes</th>
          </tr>
        </thead>
        <tbody id="portdetector-stats" aria-live="polite">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
</section>

<section id="dash-map" class="dash-panel">
  <div class="heatmap-card">
    <div class="flex space" style="align-items:flex-start; justify-content:space-between;">
      <div>
        <h2 style="margin:0">Mapa de calor</h2>
        <div class="muted">Concentración de bloqueos por geolocalización registrada.</div>
      </div>
      <div class="flex">
        <select id="heatmap-window" style="max-width: 190px;">
          <option value="current">Bloqueos actuales</option>
          <option value="24h">Últimas 24 horas</option>
          <option value="week">Última semana</option>
          <option value="month">Último mes</option>
          <option value="total" selected>Total histórico</option>
        </select>
        <button class="secondary" onclick="loadHeatmap()">Actualizar</button>
      </div>
    </div>
    <div class="heatmap-grid">
      <div>
        <div id="heatmap-map" class="heatmap-map"></div>
        <div id="heatmap-message" class="muted" style="margin-top:10px;"></div>
      </div>
      <div class="heatmap-rank">
        <div class="flex space" style="align-items:center;">
          <h3 style="margin:0">Bloqueos por país</h3>
          <span id="heatmap-rank-message" class="muted"></span>
        </div>
        <div style="max-height:340px; overflow:auto; margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>País</th>
                <th>Bloqueos</th>
              </tr>
            </thead>
            <tbody id="blocks-country-table">
              <tr><td colspan="2" class="muted">Cargando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
let offenseChart, blockChart, ratioChart;
let statsCache = null;
let heatmapMap = null;
let heatmapLayer = null;
let heatmapLabels = null;

function buildChart(ctx, label, data, borderColor) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.bucket),
      datasets: [{ label, data: data.map(d => d.count), borderColor, backgroundColor: 'rgba(56,189,248,0.15)', tension: 0.25, fill: true, pointRadius: 3 }]
    },
    options: { scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
  });
}

function updateStatsCards(offenses = {}, blocks = {}) {
  document.getElementById('offenses-total').innerText = offenses.total ?? '—';
  document.getElementById('offenses-7d').innerText = offenses.last_7d ?? '—';
  document.getElementById('offenses-24h').innerText = offenses.last_24h ?? '—';
  document.getElementById('offenses-1h').innerText = offenses.last_1h ?? '—';
  document.getElementById('blocks-total').innerText = blocks.total ?? '—';
  document.getElementById('blocks-7d').innerText = blocks.last_7d ?? '—';
  document.getElementById('blocks-24h').innerText = blocks.last_24h ?? '—';
  document.getElementById('blocks-1h').innerText = blocks.last_1h ?? '—';
  document.getElementById('blocks-current').innerText = blocks.current ?? '—';
}

function cleanCharts() {
  if (offenseChart) offenseChart.destroy();
  if (blockChart) blockChart.destroy();
  if (ratioChart) ratioChart.destroy();
}

function switchDashTab(tab) {
  document.querySelectorAll('.dash-tab').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
  document.querySelectorAll('.dash-panel').forEach(panel => panel.classList.toggle('active', panel.id === `dash-${tab}`));
  if (tab === 'map') {
    loadHeatmap();
  }
}

function renderCharts(offenseRange, blockRange) {
  if (!statsCache) {
    cleanCharts();
    return;
  }

  const offenses = statsCache.offenses || {};
  const blocks = statsCache.blocks || {};
  const offenseTimeline = offenses.timeline?.[offenseRange] || [];
  const blockTimeline = blocks.timeline?.[blockRange] || [];

  cleanCharts();
  try {
    offenseChart = buildChart(
      document.getElementById('offenses-chart'),
      'Ofensas',
      offenseTimeline,
      '#38bdf8',
    );
    blockChart = buildChart(
      document.getElementById('blocks-chart'),
      'Bloqueos',
      blockTimeline,
      '#22c55e',
    );
    renderRatioChart();
  } catch (error) {
    console.error('No se pudieron renderizar las gráficas de estadísticas', error);
  }
}

function renderRatioChart() {
  const canvas = document.getElementById('ratio-chart');
  if (!canvas || !statsCache) return;
  if (ratioChart) ratioChart.destroy();
  const offenses = statsCache.offenses || {};
  const blocks = statsCache.blocks || {};
  const offenseTimeline = offenses.timeline?.['24h'] || [];
  const blockTimeline = blocks.timeline?.['24h'] || [];
  const ratios = offenseTimeline.map((entry, idx) => {
    const offenseCount = Number(entry.count || 0);
    const blockCount = Number(blockTimeline[idx]?.count || 0);
    return offenseCount ? Number((blockCount / offenseCount).toFixed(2)) : 0;
  });
  ratioChart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: offenseTimeline.map(entry => entry.bucket),
      datasets: [
        { label: 'Ratio', data: ratios, borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.15)', tension: 0.25, fill: true, pointRadius: 3 }
      ]
    },
    options: { scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
  });
}

async function loadStats() {
  let data;
  try {
    const res = await fetch('/api/stats');
    if (!res.ok) {
      throw new Error('Respuesta no válida');
    }
    data = await res.json();
  } catch (error) {
    updateStatsCards();
    cleanCharts();
    return;
  }

  statsCache = data;
  updateStatsCards(data.offenses, data.blocks);

  const offenseRange = document.getElementById('offenses-range-selector')?.value || '7d';
  const blockRange = document.getElementById('blocks-range-selector')?.value || '7d';
  renderCharts(offenseRange, blockRange);
}

function renderTableMessage(tbody, message, colspan) {
  tbody.innerHTML = `<tr><td colspan="${colspan}" class="muted">${message}</td></tr>`;
}

async function loadTopIps() {
  const tbody = document.getElementById('top-ips-table');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 4);
  try {
    const res = await fetch('/api/dashboard/top_ips?limit=10');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.detail || 'No se pudieron cargar las IPs.');
    }
    if (!data.length) {
      renderTableMessage(tbody, 'Sin datos.', 4);
      return;
    }
    tbody.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.ip}</td><td>${item.score}</td><td>${item.offenses}</td><td>${item.blocks}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(tbody, error.message || 'Error al cargar.', 4);
  }
}

async function loadExpiringBlocks() {
  const tbody = document.getElementById('expiring-blocks-table');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 3);
  try {
    const res = await fetch('/api/dashboard/blocks/expiring?within_minutes=60&limit=10');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.detail || 'No se pudieron cargar los bloqueos.');
    }
    if (!data.length) {
      renderTableMessage(tbody, 'Sin bloqueos próximos.', 3);
      return;
    }
    tbody.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.ip}</td><td>${item.minutes_left}</td><td>${item.reason || '-'}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(tbody, error.message || 'Error al cargar.', 3);
  }
}

async function loadBlockReasons() {
  const tbody = document.getElementById('block-reasons-table');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 2);
  try {
    const res = await fetch('/api/dashboard/blocks/reasons?limit=10');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.detail || 'No se pudieron cargar los motivos.');
    }
    if (!data.length) {
      renderTableMessage(tbody, 'Sin datos.', 2);
      return;
    }
    tbody.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.reason}</td><td>${item.count}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(tbody, error.message || 'Error al cargar.', 2);
  }
}

async function loadDashboardHealth() {
  const firewallTbody = document.getElementById('firewall-health-table');
  const pluginTbody = document.getElementById('plugin-health-table');
  if (firewallTbody) renderTableMessage(firewallTbody, 'Cargando...', 3);
  if (pluginTbody) renderTableMessage(pluginTbody, 'Cargando...', 3);
  try {
    const res = await fetch('/api/dashboard/health');
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.detail || 'No se pudo cargar el estado.');
    }
    if (firewallTbody) {
      firewallTbody.innerHTML = '';
      const items = data.firewalls || [];
      if (!items.length) {
        renderTableMessage(firewallTbody, 'Sin firewalls.', 3);
      } else {
        items.forEach(item => {
          const tag = item.available ? 'ok' : 'bad';
          const label = item.available ? 'ONLINE' : 'OFFLINE';
          const latency = item.latency_ms !== null ? `${item.latency_ms} ms` : '—';
          const row = document.createElement('tr');
          row.innerHTML = `<td>${item.name} (${item.type})</td><td><span class="tag ${tag}">${label}</span></td><td>${latency}</td>`;
          firewallTbody.appendChild(row);
        });
      }
    }
    if (pluginTbody) {
      pluginTbody.innerHTML = '';
      const items = data.plugins || [];
      if (!items.length) {
        renderTableMessage(pluginTbody, 'Sin plugins.', 3);
      } else {
        items.forEach(item => {
          const tag = item.enabled ? 'ok' : 'warn';
          const label = item.enabled ? 'ACTIVO' : 'APAGADO';
          const row = document.createElement('tr');
          row.innerHTML = `<td>${item.name}</td><td><span class="tag ${tag}">${label}</span></td><td>${item.last_24h || 0}</td>`;
          pluginTbody.appendChild(row);
        });
      }
    }
  } catch (error) {
    if (firewallTbody) renderTableMessage(firewallTbody, error.message || 'Error al cargar.', 3);
    if (pluginTbody) renderTableMessage(pluginTbody, error.message || 'Error al cargar.', 3);
  }
}

async function loadLiveFeed() {
  const tbody = document.getElementById('live-feed-table');
  const filter = document.getElementById('live-feed-filter');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 3);
  const plugin = filter ? filter.value : '';
  const url = plugin ? `/api/dashboard/feed?limit=30&plugin=${plugin}` : '/api/dashboard/feed?limit=30';
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.detail || 'No se pudo cargar el feed.');
    }
    if (!data.length) {
      renderTableMessage(tbody, 'Sin eventos recientes.', 3);
      return;
    }
    tbody.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('tr');
      const time = new Date(item.created_at).toLocaleTimeString();
      const detail = item.description_clean || item.description || '-';
      row.innerHTML = `<td>${time}</td><td>${item.source_ip}</td><td>${detail}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(tbody, error.message || 'Error al cargar.', 3);
  }
}

async function loadProxyTrapStats() {
  const tbody = document.getElementById('proxytrap-stats');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 2);
  try {
    const res = await fetch('/api/plugins/proxytrap/stats');
    if (!res.ok) {
      throw new Error('No se pudieron cargar las estadísticas.');
    }
    const data = await res.json();
    const entries = data.top_domains || [];
    if (!entries.length) {
      renderTableMessage(tbody, 'Sin datos registrados.', 2);
      return;
    }
    tbody.innerHTML = '';
    entries.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.domain}</td><td>${item.hits}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(
      tbody,
      error.message || 'No se pudieron cargar las estadísticas.',
      2,
    );
  }
}

async function loadPortDetectorStats() {
  const tbody = document.getElementById('portdetector-stats');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 3);
  try {
    const res = await fetch('/api/plugins/portdetector/stats');
    if (!res.ok) {
      let detail = 'No se pudieron cargar las estadísticas.';
      try {
        const data = await res.json();
        detail = data.detail || detail;
      } catch (error) {
        // Ignorar errores de parseo y mostrar mensaje genérico
      }
      throw new Error(detail);
    }
    const data = await res.json();
    const entries = data.top_ports || [];
    if (!entries.length) {
      renderTableMessage(tbody, 'Sin datos registrados.', 3);
      return;
    }
    tbody.innerHTML = '';
    entries.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.port}</td><td>${(item.protocol || '').toUpperCase()}</td><td>${item.hits}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(
      tbody,
      error.message || 'No se pudieron cargar las estadísticas.',
      3,
    );
  }
}

function loadPluginStats() {
  loadProxyTrapStats();
  loadPortDetectorStats();
}

function initHeatmap() {
  const container = document.getElementById('heatmap-map');
  if (!container || heatmapMap) return;
  heatmapMap = L.map(container, { zoomControl: true, scrollWheelZoom: false }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(heatmapMap);
  heatmapLayer = L.layerGroup().addTo(heatmapMap);
  heatmapLabels = L.layerGroup().addTo(heatmapMap);
}

function drawHeatmap(points) {
  initHeatmap();
  if (!heatmapLayer || !heatmapLabels) return;
  heatmapLayer.clearLayers();
  heatmapLabels.clearLayers();
  if (!points.length) {
    return;
  }

  const maxCount = Math.max(...points.map(p => p.count || 1), 1);
  const bounds = [];
  points.forEach(point => {
    const lat = Number(point.lat);
    const lon = Number(point.lon);
    if (Number.isNaN(lat) || Number.isNaN(lon)) return;
    const intensity = Math.min((point.count || 1) / maxCount, 1);
    const radius = 20000 + intensity * 80000;
    const color = `rgba(248, 113, 113, ${0.2 + 0.5 * intensity})`;
    const circle = L.circle([lat, lon], {
      radius,
      color: 'rgba(248, 113, 113, 0.6)',
      fillColor: color,
      fillOpacity: 0.6,
      weight: 1,
    });
    circle.addTo(heatmapLayer);
    const label = L.marker([lat, lon], {
      icon: L.divIcon({
        className: 'heatmap-label',
        html: `${point.count || 0}`,
        iconSize: [32, 20],
      }),
    });
    label.addTo(heatmapLabels);
    bounds.push([lat, lon]);
  });

  if (bounds.length) {
    heatmapMap.fitBounds(bounds, { padding: [20, 20] });
  }
}

function countryCodeToFlag(code) {
  if (!code || code.length !== 2) return '—';
  const base = 0x1F1E6;
  const first = code.charCodeAt(0) - 65 + base;
  const second = code.charCodeAt(1) - 65 + base;
  return String.fromCodePoint(first, second);
}

function renderBlocksByCountry(items) {
  const tbody = document.getElementById('blocks-country-table');
  tbody.innerHTML = '';
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="2" class="muted">Sin datos.</td></tr>';
    return;
  }
  items.forEach(item => {
    const flag = item.country_code ? countryCodeToFlag(item.country_code.toUpperCase()) : '—';
    const country = item.country || 'Sin datos';
    const row = document.createElement('tr');
    row.innerHTML = `<td><span class="heatmap-flag" title="${country}">${flag}</span> ${country}</td><td>${item.blocks}</td>`;
    tbody.appendChild(row);
  });
}

async function loadBlocksByCountry(windowValue) {
  const message = document.getElementById('heatmap-rank-message');
  if (message) message.textContent = '';
  try {
    const res = await fetch(`/api/offenses/blocks_by_country?limit=10&window=${windowValue}`);
    if (!res.ok) {
      throw new Error('No se pudo cargar el ranking.');
    }
    const data = await res.json();
    renderBlocksByCountry(data.countries || []);
    if (message) {
      message.textContent = (data.countries || []).length ? '' : 'Sin datos';
    }
  } catch (error) {
    const tbody = document.getElementById('blocks-country-table');
    tbody.innerHTML = '<tr><td colspan="2" class="muted">Error al cargar.</td></tr>';
    if (message) message.textContent = 'Error';
  }
}

function resolveHeatmapWindow() {
  const selector = document.getElementById('heatmap-window');
  return selector ? selector.value : 'total';
}

async function loadHeatmap() {
  const windowValue = resolveHeatmapWindow();
  const message = document.getElementById('heatmap-message');
  if (message) {
    message.textContent = 'Cargando datos...';
    message.style.color = '';
  }
  try {
    const res = await fetch(`/api/offenses/heatmap?limit=300&window=${windowValue}`);
    if (!res.ok) {
      throw new Error('No se pudo cargar el mapa.');
    }
    const data = await res.json();
    const points = data.points || [];
    drawHeatmap(points);
    if (message) {
      if (!points.length) {
        message.textContent = 'Sin datos de geolocalización. Completa geo en perfiles de IP para ver el mapa.';
        message.style.color = '#fbbf24';
      } else {
        message.textContent = `Puntos: ${points.length} · Perfiles: ${data.total_profiles || 0}`;
        message.style.color = '#67e8f9';
      }
    }
    loadBlocksByCountry(windowValue);
  } catch (error) {
    if (message) {
      message.textContent = 'Error al cargar el mapa.';
      message.style.color = '#fca5a5';
    }
  }
}

document.getElementById('offenses-range-selector').addEventListener('change', (e) => {
  renderCharts(e.target.value, document.getElementById('blocks-range-selector').value);
});

document.getElementById('blocks-range-selector').addEventListener('change', (e) => {
  renderCharts(document.getElementById('offenses-range-selector').value, e.target.value);
});

loadStats();
loadPluginStats();
loadTopIps();
loadExpiringBlocks();
loadBlockReasons();
loadDashboardHealth();
loadLiveFeed();
setInterval(loadStats, 60000);
setInterval(loadPluginStats, 120000);
setInterval(loadTopIps, 120000);
setInterval(loadExpiringBlocks, 60000);
setInterval(loadBlockReasons, 180000);
setInterval(loadDashboardHealth, 180000);
setInterval(loadLiveFeed, 30000);
setInterval(() => {
  const active = document.querySelector('.dash-panel.active');
  if (active && active.id === 'dash-map') {
    loadHeatmap();
  }
}, 120000);

document.getElementById('heatmap-window').addEventListener('change', () => {
  loadHeatmap();
});

document.getElementById('live-feed-filter').addEventListener('change', () => {
  loadLiveFeed();
});
</script>
{% endblock %}
