{% extends "base.html" %}
{% block content %}
<section class="grid stats space">
  <div class="card">
    <h2>Ofensas totales (&gt;=)</h2>
    <div class="number" id="offenses-total">0</div>
    <div class="muted">Acumulado en base de datos</div>
  </div>
  <div class="card">
    <h2>Últimos 7 días</h2>
    <div class="number" id="offenses-7d">0</div>
    <div class="muted">Eventos recientes</div>
  </div>
  <div class="card">
    <h2>Últimas 24h</h2>
    <div class="number" id="offenses-24h">0</div>
    <div class="muted">Actividad de ayer a hoy</div>
  </div>
</section>

<section class="grid stats space">
  <div class="card">
    <h2>Bloqueos totales</h2>
    <div class="number" id="blocks-total">0</div>
    <div class="muted">Histórico acumulado</div>
  </div>
  <div class="card">
    <h2>Bloqueos últimos 7 días</h2>
    <div class="number" id="blocks-7d">0</div>
    <div class="muted">Eventos recientes</div>
  </div>
  <div class="card">
    <h2>Bloqueos últimas 24h</h2>
    <div class="number" id="blocks-24h">0</div>
    <div class="muted">Actividad de ayer a hoy</div>
  </div>
  <div class="card">
    <h2>Bloqueos última hora</h2>
    <div class="number" id="blocks-1h">0</div>
    <div class="muted">Ataques en curso</div>
  </div>
  <div class="card">
    <h2>Bloqueos activos</h2>
    <div class="number" id="blocks-current">0</div>
    <div class="muted">IPs en lista negra</div>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Ofensas</h2>
        <div class="muted">Distribución por ventana temporal</div>
      </div>
    </div>
    <canvas id="offenses-chart" height="200"></canvas>
  </div>
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Bloqueos</h2>
        <div class="muted">Histórico registrado</div>
      </div>
      <select id="range-selector" style="max-width: 160px;">
        <option value="7d">Últimos 7 días</option>
        <option value="24h">Últimas 24 horas</option>
        <option value="1h">Última hora</option>
      </select>
    </div>
    <canvas id="blocks-chart" height="200"></canvas>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 18px; align-items:start;">
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">ProxyTrap</h2>
        <div class="muted">Dominios más solicitados</div>
      </div>
      <button class="secondary" onclick="loadProxyTrapStats()">Refrescar</button>
    </div>
    <div style="max-height:300px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Dominio</th>
            <th>Solicitudes</th>
          </tr>
        </thead>
        <tbody id="proxytrap-stats" aria-live="polite">
          <tr><td colspan="2" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <div class="flex space" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0">Port Detector</h2>
        <div class="muted">Puertos más solicitados</div>
      </div>
      <button class="secondary" onclick="loadPortDetectorStats()">Refrescar</button>
    </div>
    <div style="max-height:300px; overflow:auto; border:1px solid rgba(255,255,255,.05); border-radius:12px; margin-top:12px;">
      <table>
        <thead>
          <tr>
            <th>Puerto</th>
            <th>Protocolo</th>
            <th>Solicitudes</th>
          </tr>
        </thead>
        <tbody id="portdetector-stats" aria-live="polite">
          <tr><td colspan="3" class="muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
let offenseChart, blockChart;

function buildChart(ctx, label, data, borderColor) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.bucket),
      datasets: [{ label, data: data.map(d => d.count), borderColor, backgroundColor: 'rgba(56,189,248,0.15)', tension: 0.25, fill: true, pointRadius: 3 }]
    },
    options: { scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
  });
}

function updateStatsCards(offenses = {}, blocks = {}) {
  document.getElementById('offenses-total').innerText = offenses.total ?? '—';
  document.getElementById('offenses-7d').innerText = offenses.last_7d ?? '—';
  document.getElementById('offenses-24h').innerText = offenses.last_24h ?? '—';
  document.getElementById('blocks-total').innerText = blocks.total ?? '—';
  document.getElementById('blocks-7d').innerText = blocks.last_7d ?? '—';
  document.getElementById('blocks-24h').innerText = blocks.last_24h ?? '—';
  document.getElementById('blocks-1h').innerText = blocks.last_1h ?? '—';
  document.getElementById('blocks-current').innerText = blocks.current ?? '—';
}

function cleanCharts() {
  if (offenseChart) offenseChart.destroy();
  if (blockChart) blockChart.destroy();
}

async function loadStats(range = '7d') {
  let data;
  try {
    const res = await fetch('/api/stats');
    if (!res.ok) {
      throw new Error('Respuesta no válida');
    }
    data = await res.json();
  } catch (error) {
    updateStatsCards();
    cleanCharts();
    return;
  }

  updateStatsCards(data.offenses, data.blocks);

  const offenseTimeline = data.offenses?.timeline?.[range] || [];
  const blockTimeline = data.blocks?.timeline?.[range] || [];

  cleanCharts();
  try {
    offenseChart = buildChart(document.getElementById('offenses-chart'), 'Ofensas', offenseTimeline, '#38bdf8');
    blockChart = buildChart(document.getElementById('blocks-chart'), 'Bloqueos', blockTimeline, '#22c55e');
  } catch (error) {
    console.error('No se pudieron renderizar las gráficas de estadísticas', error);
  }
}

function renderTableMessage(tbody, message, colspan) {
  tbody.innerHTML = `<tr><td colspan="${colspan}" class="muted">${message}</td></tr>`;
}

async function loadProxyTrapStats() {
  const tbody = document.getElementById('proxytrap-stats');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 2);
  try {
    const res = await fetch('/api/plugins/proxytrap/stats');
    if (!res.ok) {
      throw new Error('No se pudieron cargar las estadísticas.');
    }
    const data = await res.json();
    const entries = data.top_domains || [];
    if (!entries.length) {
      renderTableMessage(tbody, 'Sin datos registrados.', 2);
      return;
    }
    tbody.innerHTML = '';
    entries.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.domain}</td><td>${item.hits}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(
      tbody,
      error.message || 'No se pudieron cargar las estadísticas.',
      2,
    );
  }
}

async function loadPortDetectorStats() {
  const tbody = document.getElementById('portdetector-stats');
  if (!tbody) return;
  renderTableMessage(tbody, 'Cargando...', 3);
  try {
    const res = await fetch('/api/plugins/portdetector/stats');
    if (!res.ok) {
      let detail = 'No se pudieron cargar las estadísticas.';
      try {
        const data = await res.json();
        detail = data.detail || detail;
      } catch (error) {
        // Ignorar errores de parseo y mostrar mensaje genérico
      }
      throw new Error(detail);
    }
    const data = await res.json();
    const entries = data.top_ports || [];
    if (!entries.length) {
      renderTableMessage(tbody, 'Sin datos registrados.', 3);
      return;
    }
    tbody.innerHTML = '';
    entries.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${item.port}</td><td>${(item.protocol || '').toUpperCase()}</td><td>${item.hits}</td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    renderTableMessage(
      tbody,
      error.message || 'No se pudieron cargar las estadísticas.',
      3,
    );
  }
}

function loadPluginStats() {
  loadProxyTrapStats();
  loadPortDetectorStats();
}

document.getElementById('range-selector').addEventListener('change', (e) => {
  loadStats(e.target.value);
});

loadStats();
loadPluginStats();
</script>
{% endblock %}
