{% extends "base.html" %}
{% block content %}
<section class="grid stats space">
  <div class="card">
    <h2>Ofensas totales</h2>
    <div class="number" id="offenses-total">0</div>
    <div class="muted">Acumulado en base de datos</div>
  </div>
  <div class="card">
    <h2>Últimos 7 días</h2>
    <div class="number" id="offenses-7d">0</div>
    <div class="muted">Eventos recientes</div>
  </div>
  <div class="card">
    <h2>Últimas 24h</h2>
    <div class="number" id="offenses-24h">0</div>
    <div class="muted">Actividad de ayer a hoy</div>
  </div>
  <div class="card">
    <h2>Bloqueos activos</h2>
    <div class="number" id="blocks-current">0</div>
    <div class="muted">IPs en lista negra</div>
  </div>
</section>

<section class="grid" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Ofensas</h2>
        <div class="muted">Distribución por ventana temporal</div>
      </div>
      <div class="pill ok" id="fw-indicator">Sincronizando...</div>
    </div>
    <canvas id="offenses-chart" height="200"></canvas>
  </div>
  <div class="chart">
    <div class="flex space">
      <div>
        <h2 style="margin: 0">Bloqueos</h2>
        <div class="muted">Histórico registrado</div>
      </div>
      <select id="range-selector" style="max-width: 160px;">
        <option value="7d">Últimos 7 días</option>
        <option value="24h">Últimas 24 horas</option>
        <option value="1h">Última hora</option>
      </select>
    </div>
    <canvas id="blocks-chart" height="200"></canvas>
  </div>
</section>

<section class="card space">
  <div class="flex space">
    <div>
      <h2 style="margin:0">Estado de conexiones con firewalls</h2>
      <div class="muted">pfSense, OPNsense o conexiones dummy configuradas</div>
    </div>
    <button class="secondary" onclick="loadStatuses()">Refrescar</button>
  </div>
  <div id="fw-status" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;"></div>
</section>

<script>
let offenseChart, blockChart;

function buildChart(ctx, label, data, borderColor) {
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.bucket),
      datasets: [{ label, data: data.map(d => d.count), borderColor, backgroundColor: 'rgba(56,189,248,0.15)', tension: 0.25, fill: true, pointRadius: 3 }]
    },
    options: { scales: { x: { ticks: { color: '#94a3b8' } }, y: { ticks: { color: '#94a3b8' } } }, plugins: { legend: { labels: { color: '#e2e8f0' } } } }
  });
}

async function loadStats(range = '7d') {
  const res = await fetch('/api/stats');
  const data = await res.json();
  document.getElementById('offenses-total').innerText = data.offenses.total;
  document.getElementById('offenses-7d').innerText = data.offenses.last_7d;
  document.getElementById('offenses-24h').innerText = data.offenses.last_24h;
  document.getElementById('blocks-current').innerText = data.blocks.current;

  const offenseTimeline = data.offenses.timeline[range];
  const blockTimeline = data.blocks.timeline[range];

  if (offenseChart) offenseChart.destroy();
  if (blockChart) blockChart.destroy();

  offenseChart = buildChart(document.getElementById('offenses-chart'), 'Ofensas', offenseTimeline, '#38bdf8');
  blockChart = buildChart(document.getElementById('blocks-chart'), 'Bloqueos', blockTimeline, '#22c55e');
}

async function loadStatuses() {
  const container = document.getElementById('fw-status');
  container.innerHTML = '<div class="muted">Consultando...</div>';
  const res = await fetch('/api/firewalls/status');
  const statuses = await res.json();
  container.innerHTML = '';
  if (!statuses.length) {
    container.innerHTML = '<div class="muted">No hay firewalls configurados todavía.</div>';
    document.getElementById('fw-indicator').innerText = 'Sin configuraciones';
    document.getElementById('fw-indicator').className = 'pill error';
    return;
  }
  let onlineCount = 0;
  statuses.forEach(status => {
    const pillClass = status.online ? 'pill ok' : 'pill error';
    if (status.online) onlineCount += 1;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="flex" style="justify-content: space-between;">
        <div>
          <div class="muted">${status.type}</div>
          <div style="font-weight:700;">${status.name}</div>
        </div>
        <span class="${pillClass}">${status.online ? 'En línea' : 'Error'}</span>
      </div>
      <div class="muted" style="margin-top:8px;">${status.message || ''}</div>
    `;
    container.appendChild(card);
  });
  const indicator = document.getElementById('fw-indicator');
  indicator.innerText = `${onlineCount}/${statuses.length} en línea`;
  indicator.className = onlineCount === statuses.length ? 'pill ok' : 'pill error';
}

document.getElementById('range-selector').addEventListener('change', (e) => {
  loadStats(e.target.value);
});

loadStats();
loadStatuses();
</script>
{% endblock %}
